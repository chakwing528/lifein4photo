<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.9</title>
    <style>
        /* --- ğŸ¨ V.9 æ¨£å¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --panel-width: 380px;
            --gray-light: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444; margin: 0; padding: 0;
            height: 100vh; overscroll-behavior: none; 
            user-select: none; -webkit-user-select: none;
            overflow: hidden;
        }

        /* --- å…¨è¢å¹•æ‹æ” --- */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #camera-wrapper {
            position: relative; width: 100%; max-width: 800px; aspect-ratio: 4/3;
            overflow: hidden; box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15vw; color: white; font-weight: 900;
            text-shadow: 0 5px 20px rgba(0,0,0,0.8); display: none;
        }

        /* --- ç‰ˆé¢é…ç½® --- */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        #setup-page {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            overflow-y: auto;
        }

        #editor-page { display: none; height: 100%; width: 100%; }

        .editor-left {
            display: flex; flex-direction: column; background: white; z-index: 10;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05);
        }

        .editor-top-fixed { 
            flex-shrink: 0; padding: 15px; border-bottom: 1px solid #eee; background: #fff; 
        }
        
        .editor-scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; scrollbar-width: thin; 
        }

        @media (min-width: 768px) {
            #editor-page { flex-direction: row; }
            .editor-left { width: var(--panel-width); height: 100%; border-right: 1px solid #eee; }
            .editor-right {
                flex: 1; height: 100%; background: var(--gray-light);
                display: flex; align-items: center; justify-content: center;
                padding: 40px; overflow: hidden;
            }
            canvas { max-height: 95vh; max-width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        }

        @media (max-width: 767px) {
            #editor-page { flex-direction: column-reverse; }
            .editor-left { width: 100%; height: 50%; border-top: 1px solid #eee; }
            .editor-right {
                width: 100%; height: 50%; background: var(--gray-light);
                display: flex; align-items: center; justify-content: center; padding: 10px;
            }
            canvas { max-height: 100%; max-width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        }

        /* --- UI å…ƒä»¶ (V.9 å„ªåŒ–) --- */
        .btn {
            border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; background: #f1f3f5; color: #495057; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:hover { background: #e9ecef; }
        .btn.active { background: var(--primary); color: white; }
        .btn:active { transform: scale(0.98); }
        
        .btn-xl {
            width: 100%; padding: 16px; font-size: 16px; margin-top: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(251, 111, 146, 0.3);
        }
        
        .section-header {
            font-size: 12px; font-weight: 700; color: #adb5bd; text-transform: uppercase;
            margin: 20px 0 10px 0; letter-spacing: 0.5px;
        }
        .section-header:first-child { margin-top: 0; }

        /* é¡è‰²/è²¼åœ–æ²è»¸ */
        .color-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 8px;
        }
        .color-dot { 
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); 
            cursor: pointer; transition: transform 0.2s;
        }
        .color-dot:active { transform: scale(0.9); }

        .sticker-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
            margin-top: 5px;
        }
        .sticker-item {
            font-size: 24px; background: white; border: 1px solid #eee; border-radius: 8px;
            height: 40px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: background 0.2s;
        }
        .sticker-item:hover { background: #f8f9fa; }

        /* ç‰©ä»¶ç·¨è¼¯é¢æ¿ (V.9 ç°¡ç´„åŒ–) */
        #object-controls {
            background: white; padding: 15px; border-radius: 12px; 
            border: 1px solid #e9ecef; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 10px;
        }
        .ctrl-row { display: flex; align-items: center; margin-bottom: 10px; gap: 8px; }
        input[type="text"] { 
            flex: 1; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; 
            font-size: 14px; outline: none; transition: border 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        /* ç…§ç‰‡ç®¡ç† (é‡æ‹) */
        .photo-manager {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
        }
        .photo-thumb-box {
            position: relative; aspect-ratio: 4/3; border-radius: 6px; overflow: hidden; 
            border: 1px solid #dee2e6; cursor: pointer;
        }
        .photo-thumb-box img { width: 100%; height: 100%; object-fit: cover; }
        .retake-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 10px;
            opacity: 0; transition: opacity 0.2s; font-weight: bold;
        }
        .photo-thumb-box:hover .retake-overlay { opacity: 1; }
        .photo-number {
            position: absolute; bottom: 2px; left: 4px; color: white; font-weight: bold; 
            font-size: 10px; text-shadow: 0 1px 2px black; pointer-events: none;
        }

        @media print {
            body { background: white; height: auto; overflow: visible; }
            #setup-page, .editor-left, #camera-modal { display: none !important; }
            #editor-page { display: block !important; }
            .editor-right { background: white; padding: 0; width: 100%; height: auto; display: block; }
            canvas { width: 100%; max-height: 100vh; object-fit: contain; box-shadow: none; margin: 0 auto; display: block; }
        }
    </style>
</head>
<body>

    <div id="setup-page" class="app-container">
        <h1 style="color:#fb6f92; margin-bottom:20px;">ğŸ“¸ äººç”Ÿå››æ ¼ V.9</h1>
        <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px;">
            <div class="section-header" style="margin-top:0;">ç‰ˆå‹å°ºå¯¸</div>
            <div style="display:flex; justify-content:center; margin-bottom:15px;">
                <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 æ›¸ç±¤</button>
                <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 ç›¸ç‰‡</button>
            </div>
            <div class="section-header">å€’æ•¸ç§’æ•¸</div>
            <div style="display:flex; justify-content:center;">
                <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
                <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
                <button class="btn" onclick="setTimer(10, this)">10ç§’</button>
            </div>
            <button class="btn-xl" onclick="startFullSession()">ğŸš€ å…¨è¢å¹•æ‹æ”</button>
        </div>
    </div>

    <div id="camera-modal">
        <div id="camera-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div id="countdown"></div>
        </div>
        <div id="camera-msg" style="color:white; margin-top:20px;">è«‹çœ‹é¡é ­... ğŸ“¸</div>
    </div>

    <div id="editor-page">
        <div class="editor-left">
            <div class="editor-top-fixed">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:16px;">ğŸ¨ ç·¨è¼¯å°</h3>
                    <button class="btn" onclick="location.reload()" style="font-size:12px; padding:5px 10px;">ğŸ”„ é‡ä¾†</button>
                </div>

                <div id="object-controls">
                    <div style="color:#868e96; font-size:11px; margin-bottom:8px; font-weight:bold;">âš¡ ç·¨è¼¯ä¸­é …ç›®</div>
                    
                    <div id="text-edit-row" class="ctrl-row">
                        <input type="text" id="edit-text-input" placeholder="è¼¸å…¥å…§å®¹" oninput="updateSelectedText(this.value)">
                    </div>
                    
                    <div id="color-edit-row" class="ctrl-row">
                        <input type="color" id="edit-color-input" style="width:100%; height:32px; border:none; padding:0; background:none;" oninput="updateSelectedColor(this.value)">
                        <div style="font-size:12px; color:#666;">é¸æ“‡é¡è‰²</div>
                    </div>

                    <button class="btn" style="background:#fff5f5; color:#e03131; width:100%; justify-content:center;" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤ç‰©ä»¶</button>
                </div>

                <div style="display:flex; gap:8px;">
                    <button class="btn" onclick="addTextObject()" style="flex:1; background:#e7f5ff; color:#1971c2;">
                        <span>âœï¸</span> æ–‡å­—
                    </button>
                    <label class="btn" style="flex:1; background:#f3f0ff; color:#6741d9;">
                        <span>ğŸ–¼ï¸</span> åœ–ç‰‡
                        <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
                    </label>
                </div>
            </div>

            <div class="editor-scroll-area">
                
                <div class="section-header">ğŸ“¸ ç…§ç‰‡ç®¡ç† (é»æ“Šé‡æ‹)</div>
                <div class="photo-manager" id="photo-manager-grid"></div>

                <div class="section-header">ğŸ¨ èƒŒæ™¯é¡è‰²</div>
                <div style="display:flex; gap:10px; margin-bottom:10px; font-size:12px; color:#666;">
                    <span>ç´”è‰² (20)</span>
                </div>
                <div class="color-grid" id="solid-color-grid"></div>
                
                <div style="display:flex; gap:10px; margin:15px 0 5px 0; font-size:12px; color:#666;">
                    <span>æ¼¸è®Š (30)</span>
                </div>
                <div class="color-grid" id="grad-color-grid"></div>

                <label class="btn" style="width:100%; box-sizing:border-box; margin-top:10px; justify-content:center;">
                    ğŸ“‚ ä¸Šå‚³èƒŒæ™¯åœ–
                    <input type="file" accept="image/*" onchange="uploadBg(this)" style="display:none;">
                </label>

                <div class="section-header">âœ¨ è²¼åœ–åº«</div>
                <div class="sticker-grid" id="sticker-grid"></div>

                <div style="margin-top:30px; padding-bottom:20px; border-top:1px solid #eee; padding-top:20px;">
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="flex:1; background:#343a40; color:white; justify-content:center;" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                        <button class="btn" style="flex:1; background:#343a40; color:white; justify-content:center;" onclick="downloadImage()">â¬‡ ä¸‹è¼‰</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-right">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>

<script>
    // --- V.9 è³‡æ–™åº« (æ“´å……æ¼¸è®Šè‰²) ---
    const SOLID_COLORS = [
        '#ffffff', '#000000', '#ffebf0', '#e0f7fa', '#fff3cd', 
        '#f3e5f5', '#e8f5e9', '#ffe0b2', '#d7ccc8', '#cfd8dc',
        '#ff8fab', '#ffc2d1', '#fb6f92', '#a2d2ff', '#bde0fe',
        '#ffafcc', '#cdb4db', '#ffc8dd', '#a9def9', '#e4c1f9'
    ];
    const GRADIENTS = [
        ['#ff9a9e', '#fecfef'], ['#a18cd1', '#fbc2eb'], ['#fad0c4', '#ffd1ff'], ['#ffecd2', '#fcb69f'],
        ['#84fab0', '#8fd3f4'], ['#a1c4fd', '#c2e9fb'], ['#fccb90', '#d57eeb'], ['#e0c3fc', '#8ec5fc'],
        ['#f093fb', '#f5576c'], ['#4facfe', '#00f2fe'], ['#43e97b', '#38f9d7'], ['#fa709a', '#fee140'],
        ['#30cfd0', '#330867'], ['#5ee7df', '#b490ca'], ['#d299c2', '#fef9d7'], ['#fddb92', '#d1fdff'],
        ['#9890e3', '#b1f4cf'], ['#ebc0fd', '#d9ded8'], ['#f6d365', '#fda085'], ['#a8edea', '#fed6e3'],
        // æ–°å¢ 10 ç¨®
        ['#5f2c82', '#49a09d'], ['#74ebd5', '#ACB6E5'], ['#22c1c3', '#fdbb2d'], ['#FC466B', '#3F5EFB'],
        ['#00b09b', '#96c93d'], ['#833ab4', '#fd1d1d'], ['#11998e', '#38ef7d'], ['#C9D6FF', '#E2E2E2'],
        ['#fe8c00', '#f83600'], ['#4e54c8', '#8f94fb']
    ];
    const EMOJIS = [
        'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
        'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ’¥', 'ğŸ’¢', 'ğŸ’¦', 'ğŸ’¨', 'ğŸ€', 'ğŸ', 'ğŸ§¸',
        'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
        'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦„',
        'ğŸ¦‹', 'ğŸ', 'ğŸ', 'ğŸŒ', 'ğŸ¢', 'ğŸ¦•', 'ğŸ¦–', 'ğŸ™', 'ğŸ¬', 'ğŸŒ¸',
        'ğŸŒ¹', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ±', 'ğŸŒ¿', 'ğŸ€', 'ğŸ', 'ğŸ”¥',
        'ğŸ’§', 'â˜€ï¸', 'â˜ï¸', 'ğŸŒˆ', 'â„ï¸', 'ğŸŒ™', 'â­', 'âš¡', 'â˜‚ï¸', 'ğŸ‘‘',
        'ğŸ’', 'ğŸ’', 'ğŸ’„', 'ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ“', 'ğŸ§¢', 'ğŸ’', 'ğŸ‘Ÿ', 'ğŸ‚',
        'ğŸ°', 'ğŸ§', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸ•', 'ğŸ”',
        'ğŸŸ', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸ™', 'ğŸ£', 'ğŸ±', 'ğŸ¦', 'ğŸ‰', 'ğŸµ',
        'ğŸ¶', 'ğŸ¤', 'ğŸ§', 'ğŸ¸', 'ğŸ¹', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ’¡', 'ğŸ‘»',
        'ğŸ‘½', 'ğŸ¤–', 'ğŸ’©', 'ğŸ’€', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ’‹', 'ğŸ’¯'
    ];

    // --- è®Šæ•¸ ---
    let stream = null;
    let photos = []; 
    let config = { format: '2x6', timer: 5, bg: '#ffebf0', bgType: 'color', bgImg: null };
    let elements = [];
    let selectedIdx = -1;
    let retakeIndex = -1;

    let interactionMode = 'NONE';
    let dragStart = {x:0, y:0};
    let initialPinchDist = 0;
    let initialScale = 1;

    const canvas = document.getElementById('finalCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('video');

    // --- åˆå§‹åŒ– ---
    function init() {
        const solidGrid = document.getElementById('solid-color-grid');
        const gradGrid = document.getElementById('grad-color-grid');
        SOLID_COLORS.forEach(c => createColorBtn(c, false, solidGrid));
        GRADIENTS.forEach(g => createColorBtn(g, true, gradGrid));

        const stickerGrid = document.getElementById('sticker-grid');
        EMOJIS.forEach(e => {
            const div = document.createElement('div');
            div.className = 'sticker-item'; div.innerText = e;
            div.onclick = () => addElement({type:'emoji', content:e, size:100});
            stickerGrid.appendChild(div);
        });

        canvas.addEventListener('mousedown', onPointerDown);
        canvas.addEventListener('touchstart', onPointerDown, {passive:false});
        window.addEventListener('mousemove', onPointerMove);
        window.addEventListener('touchmove', onPointerMove, {passive:false});
        window.addEventListener('mouseup', onPointerUp);
        window.addEventListener('touchend', onPointerUp);
    }
    
    function createColorBtn(val, isGrad, container) {
        const div = document.createElement('div');
        div.className = 'color-dot';
        if(isGrad) div.style.background = `linear-gradient(135deg, ${val[0]}, ${val[1]})`;
        else div.style.backgroundColor = val;
        div.onclick = () => {
            config.bg = val; config.bgType = isGrad?'gradient':'color'; config.bgImg=null;
            renderCanvas();
        };
        container.appendChild(div);
    }
    init();

    // --- ç›¸æ©Ÿæ§åˆ¶ ---
    function setFormat(f) { config.format = f; document.querySelectorAll('#setup-page .btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+f).classList.add('active'); }
    function setTimer(t, btn) { config.timer = t; btn.parentNode.querySelectorAll('.btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }

    async function startCameraStream() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: {ideal:1280}, height: {ideal:720} }, audio: false });
            video.srcObject = stream;
            document.getElementById('camera-modal').style.display = 'flex';
        } catch(e) { alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ'); }
    }

    async function startFullSession() {
        photos = [];
        await startCameraStream();
        document.getElementById('camera-msg').innerText = "æº–å‚™é–‹å§‹é€£æ‹ 4 å¼µ...";
        await wait(1000);
        const cnt = document.getElementById('countdown');
        for(let i=0; i<4; i++) {
            document.getElementById('camera-msg').innerText = `ç¬¬ ${i+1} / 4 å¼µ`;
            cnt.style.display = 'block';
            for(let t=config.timer; t>0; t--) { cnt.innerText=t; await wait(1000); }
            cnt.style.display = 'none';
            flash();
            snapPhoto(i); 
            await wait(1000);
        }
        stopCamera();
        enterEditor();
    }

    async function startRetake(index) {
        retakeIndex = index;
        await startCameraStream();
        document.getElementById('camera-msg').innerText = `é‡æ‹ç¬¬ ${index+1} å¼µ`;
        const cnt = document.getElementById('countdown');
        cnt.style.display = 'block';
        for(let t=3; t>0; t--) { cnt.innerText=t; await wait(1000); }
        cnt.style.display = 'none';
        flash();
        snapPhoto(index);
        await wait(500);
        stopCamera();
        renderCanvas();
        renderPhotoManager();
        retakeIndex = -1;
    }
    
    function snapPhoto(insertIndex) {
        const c = document.createElement('canvas'); c.width=800; c.height=600;
        const cx = c.getContext('2d');
        cx.translate(800,0); cx.scale(-1,1);
        const vw=video.videoWidth, vh=video.videoHeight;
        const rRatio=800/600, vRatio=vw/vh;
        let sx, sy, sw, sh;
        if(vRatio > rRatio) { sh=vh; sw=vh*rRatio; sy=0; sx=(vw-sw)/2; }
        else { sw=vw; sh=vw/rRatio; sx=0; sy=(vh-sh)/2; }
        cx.drawImage(video, sx, sy, sw, sh, 0, 0, 800, 600);
        if (retakeIndex !== -1) photos[retakeIndex] = c;
        else photos.push(c);
    }

    function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById('camera-modal').style.display='none'; }
    function wait(ms) { return new Promise(r=>setTimeout(r,ms)); }
    function flash() { const f=document.createElement('div'); f.style.cssText='position:fixed;inset:0;background:white;z-index:9999;'; document.body.appendChild(f); setTimeout(()=>f.remove(),100); }

    // --- ç·¨è¼¯å™¨ ---
    function enterEditor() {
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('editor-page').style.display = 'flex';
        renderPhotoManager();
        const pad=50, head=100, foot=400, photoH=600;
        const totalH = head + (photoH*4) + (pad*5) + foot;
        const totalW = (config.format==='2x6') ? (800+pad*2) : (800+pad*2)*2;
        const dateStr = new Date().toLocaleDateString();

        if (elements.length === 0) {
            elements = [
                { type:'text', content:'LIFE4CUTS', x:totalW/2, y:totalH - 280, size:80, rotation:0, color:'#333' },
                { type:'text', content:dateStr, x:totalW/2, y:totalH - 150, size:40, rotation:0, color:'#666' }
            ];
        }
        renderCanvas();
    }

    function renderPhotoManager() {
        const grid = document.getElementById('photo-manager-grid');
        grid.innerHTML = '';
        photos.forEach((canvas, idx) => {
            const box = document.createElement('div');
            box.className = 'photo-thumb-box';
            box.onclick = () => startRetake(idx);
            
            const img = document.createElement('img');
            img.src = canvas.toDataURL();
            const overlay = document.createElement('div');
            overlay.className = 'retake-overlay';
            overlay.innerText = 'é»æ“Šé‡æ‹';
            const num = document.createElement('div');
            num.className = 'photo-number';
            num.innerText = `#${idx+1}`;

            box.appendChild(img); box.appendChild(overlay); box.appendChild(num);
            grid.appendChild(box);
        });
    }

    // --- ç¹ªåœ–æ ¸å¿ƒ ---
    function renderCanvas() {
        const pW=800, pH=600, pad=50, head=100, foot=400;
        const colW=pW+pad*2, colH=head+(pH*4)+(pad*5)+foot;
        const finalW=(config.format==='2x6')?colW:colW*2;
        const finalH=colH;
        canvas.width = finalW; canvas.height = finalH;

        if(config.bgType==='image' && config.bgImg) {
            const img=config.bgImg; const iR=img.width/img.height, cR=finalW/finalH;
            let sx,sy,sw,sh;
            if(iR>cR) { sh=img.height; sw=sh*cR; sy=0; sx=(img.width-sw)/2; } else { sw=img.width; sh=sw/cR; sx=0; sy=(img.height-sh)/2; }
            ctx.drawImage(img, sx,sy,sw,sh, 0,0, finalW,finalH);
        } else if(config.bgType==='gradient') {
            const grd=ctx.createLinearGradient(0,0,finalW,finalH); grd.addColorStop(0,config.bg[0]); grd.addColorStop(1,config.bg[1]);
            ctx.fillStyle=grd; ctx.fillRect(0,0,finalW,finalH);
        } else { ctx.fillStyle=config.bg; ctx.fillRect(0,0,finalW,finalH); }

        const drawCol = (ox) => {
            photos.forEach((p,i)=>{
                const x=ox+pad, y=head+pad+i*(pH+pad);
                ctx.fillStyle='white'; ctx.fillRect(x-15,y-15,pW+30,pH+30);
                ctx.drawImage(p,x,y,pW,pH);
            });
        };
        drawCol(0);
        if(config.format==='4x6') { drawCol(colW); ctx.beginPath(); ctx.setLineDash([20,20]); ctx.moveTo(colW,0); ctx.lineTo(colW,finalH); ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=4; ctx.stroke(); }

        ctx.setLineDash([]);
        elements.forEach((el, i) => {
            ctx.save();
            ctx.translate(el.x, el.y);
            ctx.rotate(el.rotation * Math.PI/180);
            let w, h;
            if(el.type==='text') {
                ctx.font=`bold ${el.size}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillStyle=el.color; ctx.fillText(el.content,0,0);
                const m=ctx.measureText(el.content); w=m.width; h=el.size;
            } else if(el.type==='emoji') {
                ctx.font=`${el.size}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(el.content,0,0); w=el.size; h=el.size;
            } else if(el.type==='image') {
                const r=el.img.height/el.img.width; w=el.size; h=el.size*r;
                ctx.drawImage(el.img, -w/2, -h/2, w, h);
            }

            if(i === selectedIdx) {
                const handleR = 25; const handleDist = 60; 
                ctx.strokeStyle = '#007bff'; ctx.lineWidth = 3;
                ctx.strokeRect(-w/2-10, -h/2-10, w+20, h+20);
                ctx.beginPath(); ctx.arc(0, -h/2-handleDist, handleR, 0, Math.PI*2);
                ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                ctx.fillStyle='#007bff'; ctx.font='30px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('âŸ³', 0, -h/2-handleDist+2);
                ctx.beginPath(); ctx.arc(w/2+10, h/2+10, handleR, 0, Math.PI*2);
                ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                ctx.fillStyle='#007bff'; ctx.font='24px Arial'; ctx.fillText('â¤¡', w/2+10, h/2+12);
            }
            ctx.restore();
            el._w = w; el._h = h;
        });
    }

    // --- äº’å‹•å¼•æ“ ---
    function getPointerPos(e) {
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width/r.width, sy = canvas.height/r.height;
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x:(cx-r.left)*sx, y:(cy-r.top)*sy };
    }
    function getPinchDist(e) {
        if(e.touches.length < 2) return 0;
        return Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    }

    function onPointerDown(e) {
        e.preventDefault();
        if(e.touches && e.touches.length === 2 && selectedIdx !== -1) {
            interactionMode = 'PINCH'; initialPinchDist = getPinchDist(e); initialScale = elements[selectedIdx].size; return;
        }
        const p = getPointerPos(e);
        if(selectedIdx !== -1) {
            const el = elements[selectedIdx];
            const dx = p.x - el.x; const dy = p.y - el.y;
            const rad = -el.rotation * Math.PI/180;
            const lx = dx*Math.cos(rad) - dy*Math.sin(rad);
            const ly = dx*Math.sin(rad) + dy*Math.cos(rad);
            const w = el._w, h = el._h;
            const handleDist = 60, hitR = 50; 
            if(Math.hypot(lx-0, ly-(-h/2-handleDist)) < hitR) { interactionMode='ROTATE'; return; }
            if(Math.hypot(lx-(w/2+10), ly-(h/2+10)) < hitR) { interactionMode='SCALE'; dragStart={size:el.size, dist:Math.hypot(lx,ly)}; return; }
        }
        let hit = -1;
        for(let i=elements.length-1; i>=0; i--) {
            const el = elements[i];
            const dx = p.x - el.x; const dy = p.y - el.y;
            const limit = Math.max(el._w, el._h)/1.5 + 20;
            if(Math.hypot(dx, dy) < limit) { hit = i; break; }
        }
        selectedIdx = hit; updateUI(); renderCanvas();
        if(hit !== -1) { interactionMode='DRAG'; dragStart={x:p.x, y:p.y}; } else { interactionMode='NONE'; }
    }

    function onPointerMove(e) {
        if(interactionMode === 'NONE') return;
        e.preventDefault();
        if(interactionMode === 'PINCH' && e.touches && e.touches.length === 2) {
            const s = getPinchDist(e) / initialPinchDist; elements[selectedIdx].size = initialScale * s; renderCanvas(); return;
        }
        const p = getPointerPos(e);
        const el = elements[selectedIdx];
        if(interactionMode === 'DRAG') { el.x += (p.x - dragStart.x); el.y += (p.y - dragStart.y); dragStart = {x:p.x, y:p.y}; } 
        else if(interactionMode === 'ROTATE') { const angle = Math.atan2(p.y-el.y, p.x-el.x) * 180 / Math.PI; el.rotation = angle + 90; } 
        else if(interactionMode === 'SCALE') { const dist = Math.hypot(p.x-el.x, p.y-el.y); el.size = dragStart.size * (dist / dragStart.dist); }
        renderCanvas();
    }
    function onPointerUp() { interactionMode = 'NONE'; }

    // --- è¼”åŠ© ---
    function updateUI() {
        const p = document.getElementById('object-controls');
        if(selectedIdx===-1) { p.style.display='none'; return; }
        p.style.display='block';
        const el = elements[selectedIdx];
        if(el.type==='text') {
            document.getElementById('text-edit-row').style.display='flex';
            document.getElementById('color-edit-row').style.display='flex';
            document.getElementById('edit-text-input').value = el.content;
            document.getElementById('edit-color-input').value = el.color;
        } else {
            document.getElementById('text-edit-row').style.display='none';
            document.getElementById('color-edit-row').style.display='none';
        }
    }
    function updateSelectedText(v) { if(selectedIdx!==-1){elements[selectedIdx].content=v; renderCanvas();}}
    function updateSelectedColor(v) { if(selectedIdx!==-1){elements[selectedIdx].color=v; renderCanvas();}}
    function deleteSelected() { if(selectedIdx!==-1){elements.splice(selectedIdx,1); selectedIdx=-1; updateUI(); renderCanvas();}}
    function addTextObject() { addElement({type:'text', content:'è¼¸å…¥æ–‡å­—', size:60, color:'#000000'}); }
    function addElement(props) { elements.push({x:canvas.width/2, y:canvas.height/2, rotation:0, ...props}); selectedIdx=elements.length-1; updateUI(); renderCanvas(); }
    function uploadBg(input) { if(input.files[0]) { const i=new Image(); i.onload=()=>{config.bgImg=i;config.bgType='image';renderCanvas();}; i.src=URL.createObjectURL(input.files[0]); } }
    function uploadSticker(input) { if(input.files[0]) { const i=new Image(); i.onload=()=>{addElement({type:'image', img:i, size:200});}; i.src=URL.createObjectURL(input.files[0]); } }
    function downloadImage() { selectedIdx=-1; renderCanvas(); const l=document.createElement('a'); l.download=`life4cuts-v9-${Date.now()}.png`; l.href=canvas.toDataURL(); l.click(); }
</script>
</body>
</html>
