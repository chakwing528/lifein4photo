<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.3</title>
    <style>
        /* --- ğŸ¨ V.3 è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444;
            margin: 0; padding: 20px 10px;
            text-align: center;
            overscroll-behavior-y: none; user-select: none; -webkit-user-select: none;
        }

        h1 { margin: 10px 0; color: var(--primary-dark); font-size: 20px; letter-spacing: 1px; }

        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* é¢æ¿èˆ‡æŒ‰éˆ• */
        .panel {
            background: var(--card-bg); border-radius: 20px; padding: 15px;
            margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.8);
        }

        .btn {
            border: none; padding: 8px 16px; border-radius: 50px; font-size: 14px; font-weight: 600;
            cursor: pointer; background: #f0f0f0; color: #666; margin: 3px; transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn:active { transform: scale(0.95); }
        .btn.active { background: var(--primary); color: white; }
        
        .btn-xl {
            width: 100%; padding: 14px; font-size: 18px; margin-top: 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 12px rgba(251, 111, 146, 0.4);
        }

        /* --- ç›¸æ©Ÿé è¦½ (4:3) --- */
        #camera-wrapper {
            position: relative; width: 100%; aspect-ratio: 4 / 3;
            margin: 0 auto 20px auto; background: #000; border-radius: 12px;
            overflow: hidden; box-shadow: var(--shadow); display: none;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 6rem; color: white; font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); display: none; z-index: 10;
        }

        /* --- ç·¨è¼¯å€ --- */
        #result-area { display: none; }
        .canvas-container {
            position: relative; width: 100%; margin-bottom: 15px;
            box-shadow: var(--shadow); border-radius: 8px; touch-action: none;
        }
        canvas { display: block; width: 100%; height: auto; }

        /* --- V.3 æ–°å¢æ¨£å¼ --- */
        
        /* é¡è‰²é¸æ“‡ç¶²æ ¼ */
        .color-section { margin-bottom: 15px; text-align: left; }
        .color-scroll-container {
            display: flex; overflow-x: auto; gap: 8px; padding: 5px 0;
            scrollbar-width: none; /* Firefox */
        }
        .color-scroll-container::-webkit-scrollbar { display: none; } /* Chrome */
        
        .color-swatch {
            width: 35px; height: 35px; border-radius: 50%; border: 2px solid #eee;
            flex-shrink: 0; cursor: pointer; transition: transform 0.2s;
        }
        .color-swatch:active { transform: scale(0.9); }
        .color-swatch.selected { border: 3px solid #444; transform: scale(1.1); }

        /* è²¼åœ–ç¶²æ ¼ */
        .sticker-scroll {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;
            max-height: 150px; overflow-y: auto; padding: 5px; background: #f9f9f9; border-radius: 10px;
        }
        .sticker-btn {
            background: #fff; border: 1px solid #eee; font-size: 24px; padding: 5px;
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* æ§åˆ¶é¢æ¿ (æ—‹è½‰+ç¸®æ”¾) */
        #control-panel {
            background: #fff3cd; padding: 12px; border-radius: 12px; margin-top: 10px; display: none;
        }
        .control-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .control-label { width: 40px; font-weight: bold; }
        input[type=range] { flex-grow: 1; margin: 0 10px; }

        /* è¼¸å…¥æ¡† */
        input[type="text"] {
            width: 80%; padding: 10px; border: 2px solid #eee; border-radius: 10px;
            text-align: center; font-size: 16px; margin-bottom: 5px; background: #fafafa;
        }

        @media print {
            .no-print, .panel { display: none !important; }
            #result-area { display: block !important; position: absolute; top:0; left:0; width:100%; }
            canvas { width: 100%; height: 100%; object-fit: contain; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1 class="no-print">ğŸ“¸ äººç”Ÿå››æ ¼ V.3</h1>

    <div id="setup-panel" class="panel no-print">
        <div class="section-title">ç‰ˆå‹å°ºå¯¸</div>
        <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
        <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>

        <div style="margin-top:10px; font-size:12px; color:#888;">å€’æ•¸ç§’æ•¸</div>
        <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
        <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
        <button class="btn" onclick="setTimer(10, this)">10ç§’</button>

        <button class="btn btn-xl" onclick="startCameraProcess()">ğŸ“¸ é–‹å•Ÿé¡é ­ä¸¦æ‹æ”</button>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline muted></video>
        <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            
            <div class="color-section">
                <span style="font-size:12px; font-weight:bold; color:#666;">ğŸ¨ ç´”è‰²èƒŒæ™¯ (20è‰²)</span>
                <div class="color-scroll-container" id="solid-color-container">
                    </div>
            </div>
            
            <div class="color-section">
                <span style="font-size:12px; font-weight:bold; color:#666;">ğŸŒˆ æ¼¸è®ŠèƒŒæ™¯ (20è‰²)</span>
                <div class="color-scroll-container" id="gradient-color-container">
                    </div>
            </div>

            <label class="btn" style="width:90%; font-size:12px; margin-bottom:15px; background:#e3f2fd; color:#0d47a1;">
                ğŸ“‚ ä¸Šå‚³è‡ªè¨‚èƒŒæ™¯åœ–
                <input type="file" accept="image/*" onchange="uploadBackground(this)" style="display:none;">
            </label>

            <div style="margin-bottom:15px;">
                <input type="text" id="footer-text" value="MY LIFE 4 CUTS" oninput="redrawAll()" placeholder="åº•éƒ¨æ–‡å­—">
                <input type="text" id="date-text" placeholder="æ—¥æœŸæ™‚é–“" oninput="redrawAll()">
            </div>

            <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px;">âœ¨ ç‰¹æ•ˆè²¼åœ– (20+ç¨®)</div>
            <div class="sticker-scroll" id="emoji-grid">
                </div>
            <label class="btn" style="width:90%; margin-top:8px; font-size:12px;">
                ğŸ“‚ ä¸Šå‚³åœ–ç‰‡è²¼åœ– (PNG)
                <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
            </label>

            <div id="control-panel">
                <div style="font-size:12px; font-weight:bold; color:#856404; margin-bottom:5px;">ğŸ› ï¸ èª¿æ•´é¸å–è²¼åœ–</div>
                
                <div class="control-row">
                    <span class="control-label">å¤§å°</span>
                    <span style="font-size:16px;">â–</span>
                    <input type="range" id="size-slider" min="50" max="500" step="10" oninput="resizeSelectedSticker(this.value)">
                    <span style="font-size:16px;">â•</span>
                </div>

                <div class="control-row">
                    <span class="control-label">æ—‹è½‰</span>
                    <span style="font-size:16px;">â†º</span>
                    <input type="range" id="rotate-slider" min="0" max="360" step="5" oninput="rotateSelectedSticker(this.value)">
                    <span style="font-size:16px;">â†»</span>
                </div>

                <button class="btn" style="background:#ff6b6b; color:white; width:100%; margin-top:5px;" onclick="deleteSelectedSticker()">ğŸ—‘ï¸ åˆªé™¤æ­¤è²¼åœ–</button>
            </div>

            <div style="margin-top:20px; display: flex; gap:10px;">
                <button class="btn btn-xl" onclick="downloadImage()">â¬‡ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn btn-xl" style="background:#666;" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>
</div>

<script>
    // --- è³‡æ–™åº« (V.3) ---
    // 20ç¨®ç´”è‰²
    const SOLID_COLORS = [
        '#ffffff', '#000000', '#ffebf0', '#e0f7fa', '#fff3cd', 
        '#f3e5f5', '#e8f5e9', '#ffe0b2', '#d7ccc8', '#cfd8dc',
        '#ff8fab', '#ffc2d1', '#fb6f92', '#a2d2ff', '#bde0fe',
        '#ffafcc', '#cdb4db', '#ffc8dd', '#a9def9', '#e4c1f9'
    ];
    // 20ç¨®æ¼¸è®Š (é¡è‰²å°)
    const GRADIENTS = [
        ['#ff9a9e', '#fecfef'], ['#a18cd1', '#fbc2eb'], ['#fad0c4', '#ffd1ff'], ['#ffecd2', '#fcb69f'],
        ['#ff8177', '#ff867a'], ['#a1c4fd', '#c2e9fb'], ['#d4fc79', '#96e6a1'], ['#84fab0', '#8fd3f4'],
        ['#e0c3fc', '#8ec5fc'], ['#f093fb', '#f5576c'], ['#4facfe', '#00f2fe'], ['#43e97b', '#38f9d7'],
        ['#fa709a', '#fee140'], ['#30cfd0', '#330867'], ['#5ee7df', '#b490ca'], ['#d299c2', '#fef9d7'],
        ['#fddb92', '#d1fdff'], ['#9890e3', '#b1f4cf'], ['#ebc0fd', '#d9ded8'], ['#f6d365', '#fda085']
    ];
    // 20+ç‰¹æ•ˆè²¼åœ–
    const EMOJIS = [
        'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 
        'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ€', 'ğŸ§¸', 'ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ¦Š', 
        'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒ»', 'ğŸŒ¿', 'ğŸ”¥', 'ğŸ‘‘', 'ğŸ’', 'ğŸ’', 'ğŸ•¶ï¸', 
        'ğŸ‚', 'ğŸ‰', 'ğŸµ', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ’©', 'ğŸ’‹', 'ğŸŒˆ', 'â˜ï¸'
    ];

    // --- è®Šæ•¸å®£å‘Š ---
    const video = document.getElementById('video');
    const finalCanvas = document.getElementById('finalCanvas');
    const ctx = finalCanvas.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    const setupPanel = document.getElementById('setup-panel');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const resultArea = document.getElementById('result-area');
    
    // æ§åˆ¶é¢æ¿
    const controlPanel = document.getElementById('control-panel');
    const sizeSlider = document.getElementById('size-slider');
    const rotateSlider = document.getElementById('rotate-slider');

    let streamObj = null;
    let photos = [];
    let currentFormat = '2x6';
    let timerSeconds = 5;

    // ç·¨è¼¯ç‹€æ…‹
    let bgConfig = { type: 'color', value: '#ffebf0', stops: [] };
    let customBgImg = null;

    // è²¼åœ–ç³»çµ± { type, content, x, y, size, rotation, ratio }
    let stickers = []; 
    let selectedStickerIndex = -1;
    
    let isDragging = false;
    let dragTargetIndex = -1;
    let lastMouseX, lastMouseY;

    // --- åˆå§‹åŒ– UI ---
    function initUI() {
        // ç”Ÿæˆç´”è‰²æŒ‰éˆ•
        const solidContainer = document.getElementById('solid-color-container');
        SOLID_COLORS.forEach(color => {
            const d = document.createElement('div');
            d.className = 'color-swatch';
            d.style.backgroundColor = color;
            d.onclick = () => setBgSolid(color);
            solidContainer.appendChild(d);
        });

        // ç”Ÿæˆæ¼¸è®ŠæŒ‰éˆ•
        const gradContainer = document.getElementById('gradient-color-container');
        GRADIENTS.forEach(stops => {
            const d = document.createElement('div');
            d.className = 'color-swatch';
            d.style.background = `linear-gradient(135deg, ${stops[0]}, ${stops[1]})`;
            d.onclick = () => setBgGradient(stops);
            gradContainer.appendChild(d);
        });

        // ç”Ÿæˆè²¼åœ–æŒ‰éˆ•
        const emojiContainer = document.getElementById('emoji-grid');
        EMOJIS.forEach(emoji => {
            const b = document.createElement('button');
            b.className = 'sticker-btn';
            b.innerText = emoji;
            b.onclick = () => addEmojiSticker(emoji);
            emojiContainer.appendChild(b);
        });
        
        // è¨­å®šé è¨­æ—¥æœŸ
        const now = new Date();
        document.getElementById('date-text').value = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    initUI();

    // --- 1. ç›¸æ©Ÿæ§åˆ¶ ---
    async function startCameraProcess() {
        setupPanel.style.display = 'none';
        cameraWrapper.style.display = 'block';
        try {
            streamObj = await navigator.mediaDevices.getUserMedia({
                audio: false, video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
            });
            video.srcObject = streamObj;
            await new Promise(r => setTimeout(r, 1000));
            startCaptureLoop();
        } catch (err) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"); location.reload(); }
    }

    function stopCamera() {
        if (streamObj) { streamObj.getTracks().forEach(track => track.stop()); streamObj = null; }
        cameraWrapper.style.display = 'none';
    }

    // --- 2. æ‹æ”æµç¨‹ ---
    function setFormat(fmt) {
        currentFormat = fmt;
        document.querySelectorAll('#setup-panel .btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btn-'+fmt).classList.add('active');
    }
    function setTimer(sec, btn) {
        timerSeconds = sec;
        btn.parentNode.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function startCaptureLoop() {
        photos = [];
        cameraWrapper.scrollIntoView({behavior:'smooth'});
        for(let i=1; i<=4; i++) {
            await runCountdown(timerSeconds);
            capturePhoto();
        }
        stopCamera();
        resultArea.style.display = 'block';
        initCanvasEditor();
    }

    function runCountdown(sec) {
        return new Promise(resolve => {
            countdownEl.style.display = 'block';
            let c = sec; countdownEl.innerText = c;
            let timer = setInterval(() => {
                c--; if(c>0) countdownEl.innerText=c; else { clearInterval(timer); countdownEl.style.display='none'; resolve(); }
            }, 1000);
        });
    }

    function capturePhoto() {
        const tempC = document.createElement('canvas');
        const w = 800; const h = 600; // 4:3
        tempC.width = w; tempC.height = h;
        const tCtx = tempC.getContext('2d');
        tCtx.translate(w, 0); tCtx.scale(-1, 1);
        
        const vw = video.videoWidth; const vh = video.videoHeight;
        const rRatio = w/h; const vRatio = vw/vh;
        let sx, sy, sw, sh;
        if(vRatio > rRatio) { sh = vh; sw = vh * rRatio; sy = 0; sx = (vw-sw)/2; }
        else { sw = vw; sh = vw / rRatio; sx = 0; sy = (vh-sh)/2; }
        
        tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
        photos.push(tempC);
        
        const flash = document.createElement('div');
        flash.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;";
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 100);
    }

    // --- 3. ç•«å¸ƒç·¨è¼¯ (æ ¸å¿ƒ) ---
    function initCanvasEditor() {
        redrawAll();
        finalCanvas.addEventListener('mousedown', handlePointerDown);
        finalCanvas.addEventListener('touchstart', handlePointerDown, {passive: false});
        window.addEventListener('mousemove', handlePointerMove);
        window.addEventListener('touchmove', handlePointerMove, {passive: false});
        window.addEventListener('mouseup', handlePointerUp);
        window.addEventListener('touchend', handlePointerUp);
    }

    function redrawAll() {
        const photoW = 800; const photoH = 600; const padding = 50;
        const headerH = 80; const footerH = 350;
        const stripW = photoW + (padding*2);
        const stripH = headerH + (photoH*4) + (padding*5) + footerH;
        
        let finalW = (currentFormat === '2x6') ? stripW : stripW*2;
        let finalH = stripH;
        finalCanvas.width = finalW; finalCanvas.height = finalH;

        // 1. èƒŒæ™¯ç¹ªè£½
        if (bgConfig.type === 'image' && customBgImg) {
            const iRatio = customBgImg.width/customBgImg.height; const cRatio = finalW/finalH;
            let sx, sy, sw, sh;
            if(iRatio > cRatio) { sh=customBgImg.height; sw=sh*cRatio; sy=0; sx=(customBgImg.width-sw)/2; }
            else { sw=customBgImg.width; sh=sw/cRatio; sx=0; sy=(customBgImg.height-sh)/2; }
            ctx.drawImage(customBgImg, sx, sy, sw, sh, 0, 0, finalW, finalH);
        } else if (bgConfig.type === 'gradient') {
            const grd = ctx.createLinearGradient(0, 0, finalW, finalH);
            grd.addColorStop(0, bgConfig.stops[0]);
            grd.addColorStop(1, bgConfig.stops[1]);
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, finalW, finalH);
        } else {
            ctx.fillStyle = bgConfig.value;
            ctx.fillRect(0, 0, finalW, finalH);
        }

        // 2. ç…§ç‰‡æ¢
        drawStrip(0, stripW, finalH, photoW, photoH, headerH, padding);
        if (currentFormat === '4x6') {
            drawStrip(stripW, stripW, finalH, photoW, photoH, headerH, padding);
            ctx.beginPath(); ctx.setLineDash([20, 20]);
            ctx.moveTo(stripW, 0); ctx.lineTo(stripW, finalH);
            ctx.strokeStyle = "rgba(150,150,150,0.5)"; ctx.lineWidth = 4; ctx.stroke();
        }

        // 3. è²¼åœ– (å«æ—‹è½‰é‚è¼¯)
        ctx.setLineDash([]);
        stickers.forEach((s, index) => {
            ctx.save();
            ctx.translate(s.x, s.y);
            ctx.rotate(s.rotation * Math.PI / 180); // æ—‹è½‰

            if(s.type === 'text') {
                ctx.font = `${s.size}px Arial`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(s.content, 0, 0);
            } else if (s.type === 'image') {
                ctx.drawImage(s.content, -s.size/2, -(s.size * s.ratio)/2, s.size, s.size * s.ratio);
            }

            // é¸å–æ¡† (è·Ÿéš¨æ—‹è½‰)
            if (index === selectedStickerIndex) {
                ctx.strokeStyle = "red"; ctx.lineWidth = 3;
                const bs = s.size;
                if (s.type === 'image') ctx.strokeRect(-bs/2-10, -(bs*s.ratio)/2-10, bs+20, (bs*s.ratio)+20);
                else ctx.strokeRect(-bs/2-10, -bs/2-10, bs+20, bs+20);
            }
            ctx.restore();
        });
    }

    function drawStrip(offsetX, stripW, stripH, pW, pH, headerH, pad) {
        photos.forEach((p, i) => {
            const x = offsetX + pad; const y = headerH + pad + (i * (pH + pad));
            ctx.fillStyle = "white"; ctx.fillRect(x-15, y-15, pW+30, pH+30);
            ctx.drawImage(p, x, y, pW, pH);
        });
        ctx.textAlign = 'center';
        // åˆ¤æ–·æ–‡å­—é¡è‰² (é»‘åº•ç”¨ç™½å­—)
        ctx.fillStyle = (bgConfig.value === '#000000') ? '#fff' : '#333';
        const txt1 = document.getElementById('footer-text').value;
        ctx.font = "bold 60px Arial"; ctx.fillText(txt1, offsetX + stripW/2, stripH - 180);
        const txt2 = document.getElementById('date-text').value;
        ctx.font = "30px Arial"; ctx.fillText(txt2, offsetX + stripW/2, stripH - 100);
    }

    // --- äº’å‹•æ§åˆ¶ ---
    function setBgSolid(color) { bgConfig = {type:'color', value:color}; customBgImg=null; redrawAll(); }
    function setBgGradient(stops) { bgConfig = {type:'gradient', stops:stops}; customBgImg=null; redrawAll(); }
    
    function uploadBackground(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => { customBgImg = img; bgConfig.type='image'; redrawAll(); };
                img.src = e.target.result;
            }; r.readAsDataURL(input.files[0]);
        }
    }

    function addEmojiSticker(emoji) {
        stickers.push({ type:'text', content:emoji, x:finalCanvas.width/2, y:finalCanvas.height/2, size:150, rotation:0 });
        selectSticker(stickers.length-1); redrawAll();
    }
    
    function uploadSticker(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image();
                img.onload = () => {
                    stickers.push({ type:'image', content:img, x:finalCanvas.width/2, y:finalCanvas.height/2, size:200, rotation:0, ratio:img.height/img.width });
                    selectSticker(stickers.length-1); redrawAll();
                }; img.src = e.target.result;
            }; r.readAsDataURL(input.files[0]);
        }
    }

    // é¸å–èˆ‡èª¿æ•´
    function selectSticker(index) {
        selectedStickerIndex = index;
        if (index !== -1) {
            controlPanel.style.display = 'block';
            sizeSlider.value = stickers[index].size;
            rotateSlider.value = stickers[index].rotation;
        } else {
            controlPanel.style.display = 'none';
        }
    }
    
    function resizeSelectedSticker(val) {
        if (selectedStickerIndex!==-1) { stickers[selectedStickerIndex].size = parseInt(val); redrawAll(); }
    }
    
    function rotateSelectedSticker(val) {
        if (selectedStickerIndex!==-1) { stickers[selectedStickerIndex].rotation = parseInt(val); redrawAll(); }
    }
    
    function deleteSelectedSticker() {
        if (selectedStickerIndex!==-1) { stickers.splice(selectedStickerIndex, 1); selectSticker(-1); redrawAll(); }
    }

    // æ‹–æ›³ (ç°¡å–®åˆ¤å®šä¸­å¿ƒè·é›¢)
    function getPointerPos(e) {
        const r = finalCanvas.getBoundingClientRect();
        const sx = finalCanvas.width/r.width; const sy = finalCanvas.height/r.height;
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (cx-r.left)*sx, y: (cy-r.top)*sy };
    }
    
    function handlePointerDown(e) {
        e.preventDefault();
        const pos = getPointerPos(e);
        let clicked = -1;
        for (let i = stickers.length - 1; i >= 0; i--) {
            const s = stickers[i];
            const hit = s.size/1.5; // åˆ¤å®šç¯„åœ
            if (Math.abs(pos.x - s.x) < hit && Math.abs(pos.y - s.y) < hit) { clicked = i; break; }
        }
        if (clicked !== -1) {
            selectSticker(clicked);
            isDragging = true; dragTargetIndex = clicked;
            lastMouseX = pos.x; lastMouseY = pos.y;
            redrawAll();
        } else { selectSticker(-1); redrawAll(); }
    }
    
    function handlePointerMove(e) {
        if (!isDragging || dragTargetIndex===-1) return;
        e.preventDefault();
        const pos = getPointerPos(e);
        stickers[dragTargetIndex].x += (pos.x - lastMouseX);
        stickers[dragTargetIndex].y += (pos.y - lastMouseY);
        lastMouseX = pos.x; lastMouseY = pos.y;
        redrawAll();
    }
    
    function handlePointerUp() { isDragging = false; dragTargetIndex = -1; }

    function downloadImage() {
        const saved = selectedStickerIndex; selectedStickerIndex = -1; redrawAll();
        const link = document.createElement('a');
        link.download = `life4cuts-v3-${Date.now()}.png`;
        link.href = finalCanvas.toDataURL('image/png');
        link.click();
        selectedStickerIndex = saved; redrawAll();
    }
</script>
</body>
</html>
