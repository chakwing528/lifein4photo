<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.1</title>
    <style>
        /* --- ğŸ¨ V.1 è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444;
            margin: 0;
            padding: 20px 10px;
            text-align: center;
            overscroll-behavior-y: none;
            user-select: none; /* é˜²æ­¢é•·æŒ‰é¸å–æ–‡å­— */
        }

        h1 { margin: 10px 0; color: var(--primary-dark); font-size: 22px; letter-spacing: 1px; }

        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 60px; }

        /* --- é¢æ¿æ¨£å¼ --- */
        .panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.8);
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: #f0f0f0;
            color: #666;
            margin: 3px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.95); }
        .btn.active { background: var(--primary); color: white; }
        
        .btn-xl {
            width: 100%; padding: 14px; font-size: 18px; margin-top: 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 12px rgba(251, 111, 146, 0.4);
        }

        /* --- ç›¸æ©Ÿé è¦½ (åš´æ ¼ 4:3) --- */
        #camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 480px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            margin: 0 auto 20px auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: none; /* é è¨­éš±è—ï¼ŒæŒ‰é–‹å§‹æ‰é¡¯ç¤º */
            
            /* å¼·åˆ¶ 4:3 æ¯”ä¾‹ (Aspect Ratio) */
            aspect-ratio: 3 / 4; 
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«æ»¿ 4:3 å®¹å™¨ */
            transform: scaleX(-1);
        }

        #countdown {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem; color: white; font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: none; z-index: 10;
        }

        /* --- Canvas ç·¨è¼¯å€ --- */
        #result-area { display: none; }
        
        .canvas-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-radius: 8px;
            touch-action: none; /* é˜²æ­¢æ‹–æ›³è²¼åœ–æ™‚æ²å‹•é é¢ */
        }
        
        canvas { display: block; width: 100%; height: auto; }

        /* --- æ§åˆ¶é … --- */
        .section-title {
            font-size: 12px; color: #888; display: block; margin: 8px 0 4px; font-weight: bold;
        }
        input[type="text"] {
            width: 80%; padding: 8px; border: 2px solid #eee; border-radius: 8px; text-align: center;
        }
        
        /* è²¼åœ–æŒ‰éˆ•ç¶²æ ¼ */
        .sticker-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 5px;
        }
        .sticker-btn {
            background: #fff; border: 1px solid #eee; font-size: 20px; padding: 5px; border-radius: 8px; cursor: pointer;
        }

        @media print {
            body { background: white; padding: 0; }
            .no-print, .panel { display: none !important; }
            #result-area { display: block !important; }
            canvas { max-height: 100vh; width: auto; margin: 0 auto; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1 class="no-print">ğŸ“¸ äººç”Ÿå››æ ¼ V.1</h1>

    <div id="setup-panel" class="panel no-print">
        <div class="section-title">ç‰ˆå‹å°ºå¯¸</div>
        <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
        <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>

        <div class="section-title">å€’æ•¸ç§’æ•¸</div>
        <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
        <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
        <button class="btn" onclick="setTimer(10, this)">10ç§’</button>

        <button class="btn btn-xl" onclick="startCameraProcess()">ğŸ“¸ é–‹å•Ÿé¡é ­ä¸¦æ‹æ”</button>
        <p style="font-size:11px; color:#aaa; margin-top:5px;">(æ‹æ”å®Œæˆå¾Œé¡é ­å°‡è‡ªå‹•é—œé–‰)</p>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline muted></video>
        <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            <div class="section-title">ğŸ¨ è£é£¾ç…§ç‰‡ (å¯æ‹–æ›³è²¼åœ–ï¼Œé»å…©ä¸‹åˆªé™¤)</div>
            
            <div style="margin-bottom:10px;">
                <button class="btn" style="background:#fff; border:1px solid #ddd;" onclick="setBgColor('#ffffff')">ç™½</button>
                <button class="btn" style="background:#222; color:#fff;" onclick="setBgColor('#000000')">é»‘</button>
                <button class="btn" style="background:#ffebf0;" onclick="setBgColor('#ffebf0')">ç²‰</button>
                <button class="btn" style="background:#e0f7fa;" onclick="setBgColor('#e0f7fa')">è—</button>
                <input type="color" oninput="setBgColor(this.value)" style="vertical-align:middle; width:30px; border:none;">
            </div>

            <input type="text" id="footer-text" value="MY LIFE 4 CUTS" placeholder="è¼¸å…¥åº•éƒ¨æ–‡å­—" oninput="redrawAll()">
            <div style="margin-top:5px;">
                <label style="font-size:12px;"><input type="checkbox" id="chk-date" checked onchange="redrawAll()"> é¡¯ç¤ºæ—¥æœŸ</label>
            </div>

            <div class="section-title">âœ¨ æ·»åŠ ç‰¹æ•ˆ (é»æ“Šæ–°å¢)</div>
            <div class="sticker-grid">
                <button class="sticker-btn" onclick="addEmojiSticker('â¤ï¸')">â¤ï¸</button>
                <button class="sticker-btn" onclick="addEmojiSticker('âœ¨')">âœ¨</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ€')">ğŸ€</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ±')">ğŸ±</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ¶')">ğŸ¶</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ”¥')">ğŸ”¥</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ‘‘')">ğŸ‘‘</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ•¶ï¸')">ğŸ•¶ï¸</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸŒˆ')">ğŸŒˆ</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸŒ¸')">ğŸŒ¸</button>
            </div>
            
            <div style="margin-top:10px;">
                <label class="btn" style="font-size:12px; display:block;">
                    ğŸ“‚ ä¸Šå‚³åœ–ç‰‡è²¼åœ– (PNG)
                    <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
                </label>
            </div>

            <div style="margin-top:15px; display: flex; gap:10px;">
                <button class="btn btn-xl" onclick="downloadImage()">â¬‡ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn btn-xl" style="background:#666;" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const video = document.getElementById('video');
    const finalCanvas = document.getElementById('finalCanvas');
    const ctx = finalCanvas.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    const setupPanel = document.getElementById('setup-panel');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const resultArea = document.getElementById('result-area');

    let streamObj = null;
    let photos = [];
    let currentFormat = '2x6';
    let timerSeconds = 5;

    // --- ç·¨è¼¯ç‹€æ…‹ (V.1 æ–°å¢) ---
    let bgColor = '#ffebf0';
    let stickers = []; // å„²å­˜æ‰€æœ‰è²¼åœ–ç‰©ä»¶: {type: 'text'|'image', content: 'â¤ï¸'|imgObj, x, y, size}
    let isDragging = false;
    let dragTarget = null;
    let lastMouseX, lastMouseY;

    // --- 1. ç›¸æ©Ÿæ§åˆ¶ (éš±ç§å„ªå…ˆ) ---
    
    async function startCameraProcess() {
        setupPanel.style.display = 'none';
        cameraWrapper.style.display = 'block'; // é¡¯ç¤ºé è¦½æ¡†
        
        try {
            // é–‹å•Ÿç›¸æ©Ÿ
            streamObj = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 960 } }
            });
            video.srcObject = streamObj;
            
            // ç­‰å¾…ä¸€ä¸‹è®“ç›¸æ©Ÿæº–å‚™å¥½
            await new Promise(r => setTimeout(r, 1000));
            
            startCaptureLoop();
        } catch (err) {
            alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™");
            location.reload();
        }
    }

    function stopCamera() {
        if (streamObj) {
            streamObj.getTracks().forEach(track => track.stop());
            streamObj = null;
        }
        cameraWrapper.style.display = 'none'; // æ‹æ”å®Œéš±è—
    }

    // --- 2. æ‹æ”æµç¨‹ ---
    function setFormat(fmt) {
        currentFormat = fmt;
        document.querySelectorAll('#setup-panel .btn').forEach(b => {
             if(b.id === 'btn-2x6' || b.id === 'btn-4x6') b.classList.remove('active');
        });
        document.getElementById('btn-'+fmt).classList.add('active');
    }

    function setTimer(sec, btn) {
        timerSeconds = sec;
        btn.parentNode.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function startCaptureLoop() {
        photos = [];
        // æ»¾å‹•åˆ°ç›¸æ©Ÿä½ç½®
        cameraWrapper.scrollIntoView({behavior:'smooth'});

        for(let i=1; i<=4; i++) {
            await runCountdown(timerSeconds);
            capturePhoto();
        }

        // æ‹å®Œ 4 å¼µ
        stopCamera(); // é—œé–‰é¡é ­
        resultArea.style.display = 'block';
        initCanvasEditor(); // åˆå§‹åŒ–ç·¨è¼¯å™¨
    }

    function runCountdown(sec) {
        return new Promise(resolve => {
            countdownEl.style.display = 'block';
            let c = sec;
            countdownEl.innerText = c;
            let timer = setInterval(() => {
                c--;
                if(c > 0) countdownEl.innerText = c;
                else {
                    clearInterval(timer);
                    countdownEl.style.display = 'none';
                    resolve();
                }
            }, 1000);
        });
    }

    function capturePhoto() {
        const tempC = document.createElement('canvas');
        const w = 800;
        const h = 600; // 4:3 æ¯”ä¾‹
        tempC.width = w;
        tempC.height = h;
        const tCtx = tempC.getContext('2d');
        
        tCtx.translate(w, 0);
        tCtx.scale(-1, 1);

        // è£åˆ‡é‚è¼¯ï¼šç¢ºä¿å’Œé è¦½æ¡†ä¸€æ¨£æ˜¯ 4:3
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const rRatio = w/h;
        const vRatio = vw/vh;
        let sx, sy, sw, sh;

        if(vRatio > rRatio) {
            sh = vh; sw = vh * rRatio; sy = 0; sx = (vw-sw)/2;
        } else {
            sw = vw; sh = vw / rRatio; sx = 0; sy = (vh-sh)/2;
        }
        tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
        photos.push(tempC);

        // é–ƒå…‰ç‰¹æ•ˆ
        const flash = document.createElement('div');
        flash.style.position = 'fixed'; top:0; left:0; width:'100%'; height:'100%';
        flash.style.background='white'; flash.style.zIndex='9999';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 100);
    }

    // --- 3. ç•«å¸ƒç·¨è¼¯å¼•æ“ (V.1 æ ¸å¿ƒ) ---
    
    function initCanvasEditor() {
        // è¨­å®š Canvas åˆå§‹å¤§å°ä¸¦ç¹ªè£½
        redrawAll();
        
        // ç¶å®šæ‹–æ›³äº‹ä»¶
        finalCanvas.addEventListener('mousedown', handlePointerDown);
        finalCanvas.addEventListener('touchstart', handlePointerDown, {passive: false});
        
        window.addEventListener('mousemove', handlePointerMove);
        window.addEventListener('touchmove', handlePointerMove, {passive: false});
        
        window.addEventListener('mouseup', handlePointerUp);
        window.addEventListener('touchend', handlePointerUp);
        
        // é›™æ“Šåˆªé™¤
        finalCanvas.addEventListener('dblclick', handleDoubleClick);
    }

    // é‡ç¹ªæ•´å€‹ç•«é¢ (èƒŒæ™¯ -> ç…§ç‰‡ -> è²¼åœ–)
    function redrawAll() {
        const photoW = 800;
        const photoH = 600;
        const padding = 50;
        const headerH = 80;
        const footerH = 350;

        const stripW = photoW + (padding*2);
        const stripH = headerH + (photoH*4) + (padding*5) + footerH;
        
        let finalW = (currentFormat === '2x6') ? stripW : stripW*2;
        let finalH = stripH;

        finalCanvas.width = finalW;
        finalCanvas.height = finalH;

        // 1. ç•«èƒŒæ™¯
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, finalW, finalH);

        // 2. ç•«ç…§ç‰‡æ¢ (Base)
        drawPhotoStrip(0, stripW, finalH, photoW, photoH, headerH, padding);
        if (currentFormat === '4x6') {
            drawPhotoStrip(stripW, stripW, finalH, photoW, photoH, headerH, padding);
            // è™›ç·š
            ctx.beginPath();
            ctx.setLineDash([20, 20]);
            ctx.moveTo(stripW, 0);
            ctx.lineTo(stripW, finalH);
            ctx.strokeStyle = "rgba(150,150,150,0.5)";
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        // 3. ç•«æ‰€æœ‰è²¼åœ–
        ctx.setLineDash([]); // é‡ç½®è™›ç·š
        stickers.forEach(s => {
            ctx.save();
            ctx.translate(s.x, s.y);
            if(s.type === 'text') {
                ctx.font = `${s.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(s.content, 0, 0);
            } else if (s.type === 'image') {
                // åœ–ç‰‡ç½®ä¸­ç¹ªè£½
                ctx.drawImage(s.content, -s.size/2, -(s.size * s.ratio)/2, s.size, s.size * s.ratio);
            }
            ctx.restore();
        });
    }

    function drawPhotoStrip(offsetX, stripW, stripH, pW, pH, headerH, pad) {
        // ç•«ç…§ç‰‡
        photos.forEach((p, i) => {
            const x = offsetX + pad;
            const y = headerH + pad + (i * (pH + pad));
            ctx.fillStyle = "white";
            ctx.fillRect(x-15, y-15, pW+30, pH+30);
            ctx.drawImage(p, x, y, pW, pH);
        });

        // ç•«æ–‡å­—
        ctx.fillStyle = (bgColor === '#000000') ? '#fff' : '#333';
        ctx.textAlign = 'center';
        
        const txt1 = document.getElementById('footer-text').value;
        ctx.font = "bold 60px Arial";
        ctx.fillText(txt1, offsetX + stripW/2, stripH - 180);

        if(document.getElementById('chk-date').checked) {
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            ctx.font = "30px Arial";
            ctx.fillText(dateStr, offsetX + stripW/2, stripH - 100);
        }
    }

    // --- 4. è²¼åœ–æ§åˆ¶ç³»çµ± ---

    function setBgColor(c) { bgColor = c; redrawAll(); }

    function addEmojiSticker(emoji) {
        stickers.push({
            type: 'text',
            content: emoji,
            x: finalCanvas.width / 2, // é è¨­åœ¨ä¸­é–“
            y: finalCanvas.height / 2,
            size: 150 // å¤§å°
        });
        redrawAll();
        // æç¤ºç”¨æˆ¶å¯ä»¥æ‹–æ›³
        if(stickers.length === 1) alert("è²¼åœ–å·²æ–°å¢ï¼è«‹ç”¨æ‰‹æŒ‡æˆ–æ»‘é¼ æ‹–æ›³ä½ç½®ï¼Œé»å…©ä¸‹å¯åˆªé™¤ã€‚");
    }

    function uploadSticker(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    stickers.push({
                        type: 'image',
                        content: img,
                        x: finalCanvas.width / 2,
                        y: finalCanvas.height / 2,
                        size: 200, // é è¨­å¯¬åº¦
                        ratio: img.height / img.width
                    });
                    redrawAll();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 5. æ‹–æ›³é‚è¼¯ ---
    function getPointerPos(e) {
        const rect = finalCanvas.getBoundingClientRect();
        const scaleX = finalCanvas.width / rect.width;
        const scaleY = finalCanvas.height / rect.height;
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function handlePointerDown(e) {
        e.preventDefault(); // é˜²æ­¢æ»¾å‹•
        const pos = getPointerPos(e);
        
        // å¾æœ€ä¸Šé¢çš„è²¼åœ–é–‹å§‹æª¢æŸ¥æ˜¯å¦é»ä¸­ (åå‘è¿´åœˆ)
        for (let i = stickers.length - 1; i >= 0; i--) {
            const s = stickers[i];
            // ç°¡å–®åˆ¤å®šï¼šè·é›¢ä¸­å¿ƒé»ä¸€å®šç¯„åœå…§
            const hitDist = (s.type === 'text') ? s.size/1.5 : s.size/1.5;
            
            if (Math.abs(pos.x - s.x) < hitDist && Math.abs(pos.y - s.y) < hitDist) {
                isDragging = true;
                dragTarget = i;
                lastMouseX = pos.x;
                lastMouseY = pos.y;
                return;
            }
        }
    }

    function handlePointerMove(e) {
        if (!isDragging || dragTarget === null) return;
        e.preventDefault();
        
        const pos = getPointerPos(e);
        const dx = pos.x - lastMouseX;
        const dy = pos.y - lastMouseY;

        stickers[dragTarget].x += dx;
        stickers[dragTarget].y += dy;

        lastMouseX = pos.x;
        lastMouseY = pos.y;
        redrawAll();
    }

    function handlePointerUp(e) {
        isDragging = false;
        dragTarget = null;
    }

    function handleDoubleClick(e) {
        const pos = getPointerPos(e);
        // åˆªé™¤è¢«é»æ“Šçš„è²¼åœ–
        for (let i = stickers.length - 1; i >= 0; i--) {
            const s = stickers[i];
            const hitDist = (s.type === 'text') ? s.size/1.5 : s.size/1.5;
            if (Math.abs(pos.x - s.x) < hitDist && Math.abs(pos.y - s.y) < hitDist) {
                stickers.splice(i, 1); // ç§»é™¤
                redrawAll();
                return;
            }
        }
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = `life4cuts-v1-${Date.now()}.png`;
        link.href = finalCanvas.toDataURL('image/png');
        link.click();
    }
</script>
</body>
</html>
