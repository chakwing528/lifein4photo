<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿå››æ ¼ Ultimate | My Life4Cuts</title>
    <style>
        /* --- ç¶²ç«™åŸºæœ¬æ¨£å¼ --- */
        :root {
            --primary-color: #ff7eb3;
            --secondary-color: #8e44ad;
            --bg-color: #f8f9fa;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h1 { margin-bottom: 5px; color: #444; }
        
        /* --- é¢æ¿æ¨£å¼ --- */
        .panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-width: 800px;
            margin: 15px auto;
            text-align: center;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .control-group {
            border: 1px solid #eee;
            padding: 10px 15px;
            border-radius: 10px;
            background: #fafafa;
            min-width: 150px;
        }
        
        .control-title {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        /* --- æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† --- */
        .btn {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            background-color: #eee;
            color: #333;
            border: none;
            border-radius: 20px;
            margin: 3px;
            transition: 0.2s;
        }
        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }
        .btn.active { background-color: var(--primary-color); color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(255, 126, 179, 0.4); }
        
        .btn-xl { 
            font-size: 18px; 
            padding: 12px 40px; 
            background: linear-gradient(45deg, #ff7eb3, #ff758c); 
            color: white; 
            font-weight: bold;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(255, 117, 140, 0.4);
        }
        
        select, input[type="text"] {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        input[type="text"] { width: 140px; text-align: center; }

        /* --- ç›¸æ©Ÿå€åŸŸ --- */
        #camera-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            border: 4px solid #333;
            border-radius: 10px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        video {
            display: block;
            transform: scaleX(-1); /* é¡åƒ */
            object-fit: cover; 
            width: 600px;
            height: 450px; /* 4:3 */
        }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; color: white; font-weight: 900;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: none; pointer-events: none; z-index: 10;
        }

        /* --- çµæœå±•ç¤º --- */
        #result-area { display: none; margin-top: 20px; }
        canvas {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            height: auto;
            border-radius: 4px;
        }
        
        /* è£é£¾è¨­å®šå€å¡Š */
        .deco-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .label-checkbox { cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; margin: 0 5px; }

        /* åˆ—å°å„ªåŒ– */
        @media print {
            body * { visibility: hidden; }
            #result-area, #result-area canvas { visibility: visible; }
            #result-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; }
            canvas { width: 100%; max-height: 100vh; object-fit: contain; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h1>ğŸ“¸ äººç”Ÿå››æ ¼ Ultimate</h1>
        
        <div class="panel" id="setup-panel">
            <div class="control-row">
                <div class="control-group">
                    <span class="control-title">1. ç‰ˆå‹å°ºå¯¸</span>
                    <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (ç›´æ¢)</button>
                    <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ä¸¦æ’)</button>
                </div>

                <div class="control-group">
                    <span class="control-title">2. å€’æ•¸ç§’æ•¸</span>
                    <select id="timer-select">
                        <option value="3">3 ç§’ (å¿«)</option>
                        <option value="5" selected>5 ç§’ (æ¨™æº–)</option>
                        <option value="10">10 ç§’ (å„ªé›…)</option>
                        <option value="15">15 ç§’ (å……è£•)</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-xl" onclick="startCapture()">âœ¨ é–‹å§‹æ‹æ” âœ¨</button>
        </div>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline></video>
        <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            <h3>ğŸ¨ ç…§ç‰‡è£é£¾å°</h3>
            
            <div class="control-row">
                <div class="control-group">
                    <span class="control-title">æ›´æ”¹èƒŒæ™¯</span>
                    <button class="btn" onclick="setBgColor('#ffffff')">ç™½</button>
                    <button class="btn" onclick="setBgColor('#000000')">é»‘</button>
                    <button class="btn" onclick="setBgColor('#ffebf0')">ç²‰</button>
                    <button class="btn" onclick="setBgColor('#e0f7fa')">è—</button>
                    <br>
                    <input type="color" id="color-picker" oninput="setBgColor(this.value)" style="margin-top:5px; height:30px;">
                </div>

                <div class="control-group">
                    <span class="control-title">ç‰¹æ•ˆè²¼åœ–</span>
                    <button class="btn" onclick="toggleEffect('none')">ç„¡</button>
                    <button class="btn" onclick="toggleEffect('hearts')">â¤ï¸</button>
                    <button class="btn" onclick="toggleEffect('stars')">âœ¨</button>
                    <button class="btn" onclick="toggleEffect('bear')">ğŸ» å¡é€š</button>
                    <button class="btn" onclick="toggleEffect('crayon')">ğŸ–ï¸ å¡—é´‰</button>
                    <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                    <label style="font-size:12px; display:block; margin-bottom:3px;">ğŸ“‚ ä¸Šå‚³å¡é€šè²¼åœ– (PNG):</label>
                    <input type="file" accept="image/png" onchange="uploadSticker(this)" style="width:100%; font-size:12px;">
                    <div style="font-size:10px; color:#888;">(ä¾‹å¦‚: è Ÿç­†å°æ–°å»èƒŒåœ–)</div>
                </div>

                <div class="control-group deco-controls">
                    <span class="control-title">æ–‡å­—èˆ‡æ—¥æœŸ</span>
                    
                    <div>
                        <span style="font-size:12px;">åº•éƒ¨æ–‡å­—:</span>
                        <input type="text" id="footer-input" value="LIFE4CUTS" oninput="updateSettings()">
                    </div>

                    <div style="text-align: left; padding-left: 10px;">
                        <label class="label-checkbox">
                            <input type="checkbox" id="chk-date" checked onchange="updateSettings()"> é¡¯ç¤ºæ—¥æœŸ
                        </label>
                        <br>
                        <label class="label-checkbox">
                            <input type="checkbox" id="chk-time" onchange="updateSettings()"> é¡¯ç¤ºæ™‚é–“
                        </label>
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-xl" onclick="downloadImage()">ğŸ“¥ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                <button class="btn" onclick="location.reload()">ğŸ”„ å…¨éƒ¨é‡ä¾†</button>
            </div>
        </div>

        <canvas id="finalCanvas"></canvas>
    </div>

    <script>
        // --- è®Šæ•¸ ---
        const video = document.getElementById('video');
        const finalCanvas = document.getElementById('finalCanvas');
        const ctx = finalCanvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const resultArea = document.getElementById('result-area');
        const cameraWrapper = document.getElementById('camera-wrapper');
        const footerInput = document.getElementById('footer-input');

        let photos = []; 
        let currentFormat = '2x6';
        
        // è£é£¾ç‹€æ…‹
        let currentBgType = 'color'; 
        let currentBgValue = '#ffebf0'; 
        let currentEffect = 'none'; 
        let customStickerImg = null; // å„²å­˜ä½¿ç”¨è€…ä¸Šå‚³çš„è²¼åœ–

        // --- 1. ç›¸æ©Ÿåˆå§‹åŒ– ---
        navigator.mediaDevices.getUserMedia({ 
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" } 
        }).then(stream => { video.srcObject = stream; })
          .catch(err => alert("ç›¸æ©ŸéŒ¯èª¤: " + err));

        // --- 2. æ‹æ”æ§åˆ¶ ---
        function setFormat(fmt) {
            currentFormat = fmt;
            document.getElementById('btn-2x6').className = fmt === '2x6' ? 'btn active' : 'btn';
            document.getElementById('btn-4x6').className = fmt === '4x6' ? 'btn active' : 'btn';
            if(photos.length === 4) renderFinalImage(); 
        }

        async function startCapture() {
            photos = [];
            resultArea.style.display = 'none';
            document.getElementById('setup-panel').style.display = 'none'; // æ‹æ”æ™‚éš±è—è¨­å®š
            cameraWrapper.scrollIntoView({ behavior: 'smooth' });

            // ç²å–é¸æ“‡çš„ç§’æ•¸
            const timerSeconds = parseInt(document.getElementById('timer-select').value);

            for (let i = 1; i <= 4; i++) {
                await runCountdown(timerSeconds);
                capturePhoto();
            }
            
            document.getElementById('setup-panel').style.display = 'block'; // æ‹å®Œé¡¯ç¤ºè¨­å®š
            resultArea.style.display = 'block';
            renderFinalImage();
            location.href = "#result-area";
        }

        function runCountdown(sec) {
            return new Promise(resolve => {
                countdownEl.style.display = 'block';
                let c = sec;
                countdownEl.innerText = c;
                let timer = setInterval(() => {
                    c--;
                    if(c > 0) countdownEl.innerText = c;
                    else {
                        clearInterval(timer);
                        countdownEl.style.display = 'none';
                        resolve();
                    }
                }, 1000);
            });
        }

        // æ™ºæ…§è£åˆ‡æ‹ç…§
        function capturePhoto() {
            const tempCanvas = document.createElement('canvas');
            const targetW = 800;
            const targetH = 600;
            tempCanvas.width = targetW;
            tempCanvas.height = targetH;
            const tCtx = tempCanvas.getContext('2d');

            tCtx.translate(targetW, 0);
            tCtx.scale(-1, 1);

            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const videoRatio = vw / vh;
            const targetRatio = targetW / targetH;
            
            let sx, sy, sw, sh;
            if (videoRatio > targetRatio) {
                sh = vh; sw = vh * targetRatio; sy = 0; sx = (vw - sw) / 2;
            } else {
                sw = vw; sh = vw / targetRatio; sx = 0; sy = (vh - sh) / 2;
            }
            tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
            photos.push(tempCanvas);
            
            document.body.style.backgroundColor = 'white';
            setTimeout(() => document.body.style.backgroundColor = '', 100);
        }

        // --- 3. è£é£¾èˆ‡è¨­å®šæ›´æ–° ---

        // ç•¶æ–‡å­—æˆ– checkbox æ”¹è®Šæ™‚ï¼Œé‡ç¹ª
        function updateSettings() {
            if(photos.length === 4) renderFinalImage();
        }

        function setBgColor(color) {
            currentBgType = 'color';
            currentBgValue = color;
            updateSettings();
        }

        function toggleEffect(effectName) {
            currentEffect = effectName;
            updateSettings();
        }

        // ä¸Šå‚³è‡ªè¨‚è²¼åœ– (ä¾‹å¦‚è Ÿç­†å°æ–°)
        function uploadSticker(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        customStickerImg = img;
                        toggleEffect('custom'); // åˆ‡æ›åˆ°è‡ªè¨‚æ¨¡å¼
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 4. æœ€çµ‚æ¸²æŸ“ (æ ¸å¿ƒé‚è¼¯) ---
        function renderFinalImage() {
            const photoW = 800;
            const photoH = 600; 
            const padding = 50;
            const headerH = 100;
            const footerH = 300; // åº•éƒ¨ç•™å¤§ä¸€é»çµ¦æ–‡å­—
            
            const stripW = photoW + (padding * 2);
            const stripH = headerH + (photoH * 4) + (padding * 5) + footerH;

            let finalW = (currentFormat === '2x6') ? stripW : stripW * 2;
            let finalH = stripH;

            finalCanvas.width = finalW;
            finalCanvas.height = finalH;

            // A. èƒŒæ™¯
            ctx.fillStyle = currentBgValue;
            ctx.fillRect(0, 0, finalW, finalH);

            // B. ç¹ªè£½ç…§ç‰‡æ¢
            function drawOneStrip(offsetX) {
                photos.forEach((p, i) => {
                    const x = offsetX + padding;
                    const y = headerH + padding + (i * (photoH + padding));
                    
                    // ç™½é‚Š
                    ctx.fillStyle = "white";
                    ctx.fillRect(x - 10, y - 10, photoW + 20, photoH + 20);
                    // ç…§ç‰‡
                    ctx.drawImage(p, x, y, photoW, photoH);
                    // ç‰¹æ•ˆ
                    drawEffects(x, y, photoW, photoH, i);
                });

                // C. åº•éƒ¨æ–‡å­—èˆ‡æ—¥æœŸé‚è¼¯
                ctx.fillStyle = (currentBgValue === '#000000') ? "#fff" : "#333";
                ctx.textAlign = "center";
                
                // 1. æ¨™é¡Œ (ä½¿ç”¨è€…è¼¸å…¥)
                const userText = footerInput.value || " ";
                ctx.font = "bold 60px Arial";
                ctx.fillText(userText, offsetX + stripW/2, finalH - 160);
                
                // 2. æ—¥æœŸèˆ‡æ™‚é–“
                const showDate = document.getElementById('chk-date').checked;
                const showTime = document.getElementById('chk-time').checked;
                
                if (showDate || showTime) {
                    const now = new Date();
                    let dateStr = "";
                    
                    if (showDate) dateStr += now.toLocaleDateString();
                    if (showDate && showTime) dateStr += "  "; // é–“éš”
                    if (showTime) dateStr += now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    ctx.font = "30px Arial";
                    ctx.fillText(dateStr, offsetX + stripW/2, finalH - 100);
                }
            }

            if (currentFormat === '2x6') {
                drawOneStrip(0);
            } else {
                drawOneStrip(0);
                drawOneStrip(stripW);
                // è™›ç·š
                ctx.beginPath();
                ctx.setLineDash([20, 20]);
                ctx.moveTo(stripW, 0);
                ctx.lineTo(stripW, finalH);
                ctx.strokeStyle = "#ccc";
                ctx.lineWidth = 4;
                ctx.stroke();
            }
        }

        // è¼”åŠ©ï¼šç¹ªè£½ç‰¹æ•ˆ
        function drawEffects(x, y, w, h, index) {
            // æ ¹æ“šå¥‡æ•¸å¶æ•¸æ ¼ç¨å¾®æ”¹è®Šä½ç½®ï¼Œè®“ç•«é¢æ´»æ½‘é»
            const offset = (index % 2 === 0) ? 0 : 20;

            if (currentEffect === 'hearts') {
                ctx.font = "80px Arial";
                ctx.fillText("â¤ï¸", x + 30, y + 80);
                ctx.fillText("â¤ï¸", x + w - 40, y + h - 30);
            } else if (currentEffect === 'stars') {
                ctx.font = "80px Arial";
                ctx.fillText("âœ¨", x + 20 + offset, y + 70);
                ctx.fillText("âœ¨", x + w - 50, y + 80 + offset);
            } else if (currentEffect === 'bear') {
                ctx.font = "100px Arial";
                // ç•«åœ¨å³ä¸‹è§’
                ctx.fillText("ğŸ»", x + w - 80, y + h - 20);
            } else if (currentEffect === 'crayon') {
                ctx.font = "80px Arial";
                // å·¦ä¸Šå’Œå³ä¸‹
                ctx.fillText("ğŸ–ï¸", x + 30, y + 80);
                ctx.fillText("ğŸŒˆ", x + w - 60, y + h - 30);
            } else if (currentEffect === 'custom' && customStickerImg) {
                // ç¹ªè£½ä½¿ç”¨è€…ä¸Šå‚³çš„åœ–ç‰‡ (ä¾‹å¦‚è Ÿç­†å°æ–°)
                // ç•«åœ¨å³ä¸‹è§’ï¼Œå¯¬åº¦è¨­ç‚º 150px
                const sW = 150;
                const sH = (customStickerImg.height / customStickerImg.width) * sW;
                ctx.drawImage(customStickerImg, x + w - sW - 10, y + h - sH - 10, sW, sH);
            }
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `life4cuts-${Date.now()}.png`;
            link.href = finalCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
