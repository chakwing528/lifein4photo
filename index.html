<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.5</title>
    <style>
        /* --- ğŸ¨ V.5 æ¨£å¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --panel-width: 380px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444; margin: 0; padding: 0;
            height: 100vh; overscroll-behavior: none; 
            user-select: none; -webkit-user-select: none;
            overflow: hidden; /* é˜²æ­¢é é¢æ»¾å‹• */
        }

        /* --- å…¨è¢å¹•æ‹æ” --- */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #camera-wrapper {
            position: relative; width: 100%; max-width: 800px; aspect-ratio: 4/3;
            overflow: hidden; box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15vw; color: white; font-weight: 900;
            text-shadow: 0 5px 20px rgba(0,0,0,0.8); display: none;
        }

        /* --- ç‰ˆé¢é…ç½® --- */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        #setup-page {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
            overflow-y: auto;
        }

        #editor-page { display: none; height: 100%; width: 100%; }

        /* é›»è…¦ç‰ˆï¼šå·¦å³åˆ†æ¬„ */
        @media (min-width: 768px) {
            #editor-page { flex-direction: row; }
            .editor-left {
                width: var(--panel-width); height: 100%; overflow-y: auto;
                background: white; border-right: 1px solid #eee; padding: 20px;
                box-sizing: border-box; box-shadow: 5px 0 15px rgba(0,0,0,0.05); z-index: 10;
            }
            .editor-right {
                flex: 1; height: 100%; background: #eee;
                display: flex; align-items: center; justify-content: center;
                padding: 40px; overflow: hidden;
            }
            canvas { max-height: 90vh; max-width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        }

        /* æ‰‹æ©Ÿç‰ˆï¼šä¸Šä¸‹åˆ†æ¬„ */
        @media (max-width: 767px) {
            #editor-page { flex-direction: column-reverse; }
            .editor-left {
                width: 100%; height: 45%; overflow-y: auto;
                background: white; padding: 15px; box-sizing: border-box; border-top: 1px solid #eee;
            }
            .editor-right {
                width: 100%; height: 55%; background: #f4f4f4;
                display: flex; align-items: center; justify-content: center; padding: 10px;
            }
            canvas { max-height: 100%; max-width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        }

        /* --- UI å…ƒä»¶ --- */
        .btn {
            border: none; padding: 10px 20px; border-radius: 50px; font-size: 14px; font-weight: 600;
            cursor: pointer; background: #f0f0f0; color: #666; margin: 5px; transition: 0.2s;
        }
        .btn.active { background: var(--primary); color: white; }
        .btn:active { transform: scale(0.95); }
        .btn-xl {
            width: 100%; padding: 16px; font-size: 18px; margin-top: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(251, 111, 146, 0.4);
        }
        .section-header {
            font-size: 12px; font-weight: bold; color: #888; text-transform: uppercase;
            margin: 15px 0 8px 0; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }

        /* é¡è‰²/è²¼åœ–æ²è»¸ */
        .scroll-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px;
            max-height: 120px; overflow-y: auto; padding: 2px;
        }
        .color-dot {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer;
        }
        .sticker-item {
            font-size: 24px; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px;
            height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* ç‰©ä»¶ç·¨è¼¯é¢æ¿ */
        #object-controls {
            background: #fff8e1; padding: 10px; border-radius: 12px; margin-bottom: 10px;
            border: 1px solid #ffe082; display: none;
        }
        .ctrl-row { display: flex; align-items: center; margin-bottom: 5px; gap: 10px; font-size: 14px; }
        input[type="text"] { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 6px; text-align: center; }

        @media print {
            body { background: white; height: auto; overflow: visible; }
            #setup-page, .editor-left, #camera-modal { display: none !important; }
            #editor-page { display: block !important; }
            .editor-right { background: white; padding: 0; width: 100%; height: auto; display: block; }
            canvas { width: 100%; max-height: 100vh; object-fit: contain; box-shadow: none; margin: 0 auto; display: block; }
        }
    </style>
</head>
<body>

    <div id="setup-page" class="app-container">
        <h1 style="color:#fb6f92; margin-bottom:20px;">ğŸ“¸ äººç”Ÿå››æ ¼ V.5</h1>
        <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px;">
            <div class="section-header">1. ç‰ˆå‹å°ºå¯¸</div>
            <div style="display:flex; justify-content:center;">
                <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
                <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>
            </div>
            <div class="section-header">2. å€’æ•¸ç§’æ•¸</div>
            <div style="display:flex; justify-content:center;">
                <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
                <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
                <button class="btn" onclick="setTimer(10, this)">10ç§’</button>
            </div>
            <button class="btn-xl" onclick="startCamera()">ğŸš€ å…¨è¢å¹•æ‹æ”</button>
        </div>
    </div>

    <div id="camera-modal">
        <div id="camera-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div id="countdown"></div>
        </div>
        <div style="color:white; margin-top:20px;">è«‹çœ‹é¡é ­... ğŸ“¸</div>
    </div>

    <div id="editor-page">
        <div class="editor-left">
            <h3 style="margin:0 0 10px 0;">ğŸ¨ è£é£¾ç…§ç‰‡</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">ğŸ’¡ æç¤ºï¼šå…©æŒ‡å¯ç¸®æ”¾ï¼Œæ‹–æ›³åœ“é»å¯æ—‹è½‰</p>

            <div id="object-controls">
                <div id="text-edit-row" class="ctrl-row">
                    <span>å…§å®¹</span>
                    <input type="text" id="edit-text-input" oninput="updateSelectedText(this.value)">
                </div>
                <div id="color-edit-row" class="ctrl-row">
                    <span>é¡è‰²</span>
                    <input type="color" id="edit-color-input" oninput="updateSelectedColor(this.value)">
                </div>
                <button class="btn" style="background:#ffcdd2; color:#c62828; width:100%; font-size:12px; margin-top:5px;" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–é …ç›®</button>
            </div>

            <div class="section-header">èƒŒæ™¯ (ç´”è‰² / æ¼¸è®Š)</div>
            <div class="scroll-container" id="color-grid"></div>
            <label class="btn" style="width:100%; box-sizing:border-box; margin-top:5px; font-size:12px; background:#e3f2fd; color:#1565c0; text-align:center; display:block;">
                ğŸ“‚ ä¸Šå‚³èƒŒæ™¯åœ–
                <input type="file" accept="image/*" onchange="uploadBg(this)" style="display:none;">
            </label>

            <div class="section-header">è²¼åœ–åº«</div>
            <div class="scroll-container" id="sticker-grid"></div>
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn" onclick="addTextObject()" style="flex:1; background:#fff3e0; color:#ef6c00;">âœï¸ åŠ æ–‡å­—</button>
                <label class="btn" style="flex:1; background:#f3e5f5; color:#8e24aa; text-align:center;">
                    ğŸ–¼ï¸ åŠ åœ–ç‰‡
                    <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
                </label>
            </div>

            <div style="margin-top:20px;">
                <button class="btn" style="width:100%; background:#333; color:white;" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                <button class="btn-xl" style="margin-top:10px;" onclick="downloadImage()">â¬‡ ä¸‹è¼‰</button>
                <button class="btn" style="width:100%; margin-top:10px; background:#eee;" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
        </div>

        <div class="editor-right">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>

<script>
    // --- ç´ æåº« (V.3 çš„å…§å®¹å›æ­¸) ---
    const SOLID_COLORS = [
        '#ffffff', '#000000', '#ffebf0', '#e0f7fa', '#fff3cd', 
        '#f3e5f5', '#e8f5e9', '#ffe0b2', '#d7ccc8', '#cfd8dc',
        '#ff8fab', '#ffc2d1', '#fb6f92', '#a2d2ff', '#bde0fe',
        '#ffafcc', '#cdb4db', '#ffc8dd', '#a9def9', '#e4c1f9'
    ];
    const GRADIENTS = [
        ['#ff9a9e', '#fecfef'], ['#a18cd1', '#fbc2eb'], ['#fad0c4', '#ffd1ff'], ['#ffecd2', '#fcb69f'],
        ['#84fab0', '#8fd3f4'], ['#a1c4fd', '#c2e9fb'], ['#fccb90', '#d57eeb'], ['#e0c3fc', '#8ec5fc']
    ];
    const EMOJIS = [
        'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 
        'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ€', 'ğŸ§¸', 'ğŸ¶', 'ğŸ±', 'ğŸ°', 
        'ğŸŒ¸', 'ğŸŒ¹', 'ğŸŒ»', 'ğŸŒ¿', 'ğŸ”¥', 'ğŸ‘‘', 'ğŸ’', 'ğŸ’', 
        'ğŸ‚', 'ğŸ‰', 'ğŸµ', 'ğŸ‘»', 'ğŸ•¶ï¸', 'ğŸŒˆ', 'â˜ï¸', 'ğŸŒ™'
    ];

    // --- è®Šæ•¸ ---
    let stream = null;
    let photos = [];
    let config = { format: '2x6', timer: 5, bg: '#ffebf0', bgType: 'color', bgImg: null };
    
    // ç‰©ä»¶: {type, content, x, y, size, rotation, color, img}
    let elements = [];
    let selectedIdx = -1;
    
    // äº’å‹•ç‹€æ…‹
    let interactionMode = 'NONE'; // NONE, DRAG, ROTATE, SCALE, PINCH
    let dragStart = {x:0, y:0};
    let initialPinchDist = 0;
    let initialScale = 1;

    // DOM
    const canvas = document.getElementById('finalCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('video');

    // --- åˆå§‹åŒ– ---
    function init() {
        // å¡«å…¥é¡è‰²
        const colorGrid = document.getElementById('color-grid');
        SOLID_COLORS.forEach(c => createColorBtn(c, false, colorGrid));
        GRADIENTS.forEach(g => createColorBtn(g, true, colorGrid));

        // å¡«å…¥è²¼åœ–
        const stickerGrid = document.getElementById('sticker-grid');
        EMOJIS.forEach(e => {
            const div = document.createElement('div');
            div.className = 'sticker-item'; div.innerText = e;
            div.onclick = () => addElement({type:'emoji', content:e, size:100});
            stickerGrid.appendChild(div);
        });

        // äº‹ä»¶ç›£è½ (æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§)
        canvas.addEventListener('mousedown', onPointerDown);
        canvas.addEventListener('touchstart', onPointerDown, {passive:false});
        window.addEventListener('mousemove', onPointerMove);
        window.addEventListener('touchmove', onPointerMove, {passive:false});
        window.addEventListener('mouseup', onPointerUp);
        window.addEventListener('touchend', onPointerUp);
    }
    
    function createColorBtn(val, isGrad, container) {
        const div = document.createElement('div');
        div.className = 'color-dot';
        if(isGrad) div.style.background = `linear-gradient(135deg, ${val[0]}, ${val[1]})`;
        else div.style.backgroundColor = val;
        div.onclick = () => {
            config.bg = val; config.bgType = isGrad?'gradient':'color'; config.bgImg=null;
            renderCanvas();
        };
        container.appendChild(div);
    }
    init();

    // --- 1. ç›¸æ©Ÿæ‹æ” ---
    function setFormat(f) { config.format = f; document.querySelectorAll('#setup-page .btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+f).classList.add('active'); }
    function setTimer(t, btn) { config.timer = t; btn.parentNode.querySelectorAll('.btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: {ideal:1280}, height: {ideal:720} }, audio: false });
            video.srcObject = stream;
            document.getElementById('camera-modal').style.display = 'flex';
            setTimeout(startShooting, 1000);
        } catch(e) { alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ'); }
    }

    async function startShooting() {
        photos = [];
        const cnt = document.getElementById('countdown');
        for(let i=0; i<4; i++) {
            cnt.style.display = 'block';
            for(let t=config.timer; t>0; t--) { cnt.innerText=t; await wait(1000); }
            cnt.style.display = 'none';
            flash();
            snapPhoto();
            await wait(1000);
        }
        stopCamera();
        enterEditor();
    }
    
    function snapPhoto() {
        const c = document.createElement('canvas'); c.width=800; c.height=600;
        const cx = c.getContext('2d');
        cx.translate(800,0); cx.scale(-1,1);
        const vw=video.videoWidth, vh=video.videoHeight;
        const rRatio=800/600, vRatio=vw/vh;
        let sx, sy, sw, sh;
        if(vRatio > rRatio) { sh=vh; sw=vh*rRatio; sy=0; sx=(vw-sw)/2; }
        else { sw=vw; sh=vw/rRatio; sx=0; sy=(vh-sh)/2; }
        cx.drawImage(video, sx, sy, sw, sh, 0, 0, 800, 600);
        photos.push(c);
    }

    function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById('camera-modal').style.display='none'; }
    function wait(ms) { return new Promise(r=>setTimeout(r,ms)); }
    function flash() { const f=document.createElement('div'); f.style.cssText='position:fixed;inset:0;background:white;z-index:9999;'; document.body.appendChild(f); setTimeout(()=>f.remove(),100); }

    // --- 2. ç·¨è¼¯å™¨ ---
    function enterEditor() {
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('editor-page').style.display = 'flex';
        
        // é è¨­ç‰©ä»¶
        const cw = (config.format==='2x6')? 900 : 1800; const ch = 2400;
        elements = [
            { type:'text', content:'LIFE4CUTS', x:cw/2, y:ch-250, size:80, rotation:0, color:'#333' },
            { type:'text', content:new Date().toLocaleDateString(), x:cw/2, y:ch-150, size:40, rotation:0, color:'#666' }
        ];
        renderCanvas();
    }

    // --- 3. ç¹ªåœ–æ ¸å¿ƒ (å«æ‰‹æŸ„) ---
    function renderCanvas() {
        const pW=800, pH=600, pad=50, head=100, foot=400;
        const colW=pW+pad*2, colH=head+(pH*4)+(pad*5)+foot;
        const finalW=(config.format==='2x6')?colW:colW*2;
        const finalH=colH;
        canvas.width = finalW; canvas.height = finalH;

        // èƒŒæ™¯
        if(config.bgType==='image' && config.bgImg) {
            const img=config.bgImg; const iR=img.width/img.height, cR=finalW/finalH;
            let sx,sy,sw,sh;
            if(iR>cR) { sh=img.height; sw=sh*cR; sy=0; sx=(img.width-sw)/2; } else { sw=img.width; sh=sw/cR; sx=0; sy=(img.height-sh)/2; }
            ctx.drawImage(img, sx,sy,sw,sh, 0,0, finalW,finalH);
        } else if(config.bgType==='gradient') {
            const grd=ctx.createLinearGradient(0,0,finalW,finalH); grd.addColorStop(0,config.bg[0]); grd.addColorStop(1,config.bg[1]);
            ctx.fillStyle=grd; ctx.fillRect(0,0,finalW,finalH);
        } else { ctx.fillStyle=config.bg; ctx.fillRect(0,0,finalW,finalH); }

        // ç…§ç‰‡
        const drawCol = (ox) => {
            photos.forEach((p,i)=>{
                const x=ox+pad, y=head+pad+i*(pH+pad);
                ctx.fillStyle='white'; ctx.fillRect(x-15,y-15,pW+30,pH+30);
                ctx.drawImage(p,x,y,pW,pH);
            });
        };
        drawCol(0);
        if(config.format==='4x6') { drawCol(colW); ctx.beginPath(); ctx.setLineDash([20,20]); ctx.moveTo(colW,0); ctx.lineTo(colW,finalH); ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.lineWidth=4; ctx.stroke(); }

        // ç‰©ä»¶
        ctx.setLineDash([]);
        elements.forEach((el, i) => {
            ctx.save();
            ctx.translate(el.x, el.y);
            ctx.rotate(el.rotation * Math.PI/180);
            
            let w, h;
            if(el.type==='text') {
                ctx.font=`bold ${el.size}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillStyle=el.color; ctx.fillText(el.content,0,0);
                const m=ctx.measureText(el.content); w=m.width; h=el.size;
            } else if(el.type==='emoji') {
                ctx.font=`${el.size}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
                ctx.fillText(el.content,0,0); w=el.size; h=el.size;
            } else if(el.type==='image') {
                const r=el.img.height/el.img.width; w=el.size; h=el.size*r;
                ctx.drawImage(el.img, -w/2, -h/2, w, h);
            }

            // é¸å–æ¡†èˆ‡æ‰‹æŸ„
            if(i === selectedIdx) {
                // æ¡†
                ctx.strokeStyle = '#007bff'; ctx.lineWidth = 3;
                ctx.strokeRect(-w/2-10, -h/2-10, w+20, h+20);
                
                // æ—‹è½‰æ‰‹æŸ„ (ä¸Šæ–¹)
                ctx.beginPath(); ctx.arc(0, -h/2-40, 15, 0, Math.PI*2);
                ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                ctx.fillStyle='#007bff'; ctx.font='20px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('âŸ³', 0, -h/2-38);

                // ç¸®æ”¾æ‰‹æŸ„ (å³ä¸‹)
                ctx.beginPath(); ctx.arc(w/2+10, h/2+10, 15, 0, Math.PI*2);
                ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
                ctx.fillStyle='#007bff'; ctx.font='16px Arial'; ctx.fillText('â¤¡', w/2+10, h/2+12);
            }
            ctx.restore();
            
            // å„²å­˜å°ºå¯¸ä¾›é»æ“Šåˆ¤å®š
            el._w = w; el._h = h;
        });
    }

    // --- 4. äº’å‹•å¼•æ“ (V.5 é‡å¯«) ---
    function getPointerPos(e) {
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width/r.width, sy = canvas.height/r.height;
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x:(cx-r.left)*sx, y:(cy-r.top)*sy, clientX:cx, clientY:cy };
    }

    // é›™æŒ‡è·é›¢
    function getPinchDist(e) {
        if(e.touches.length < 2) return 0;
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        return Math.hypot(dx, dy);
    }

    function onPointerDown(e) {
        e.preventDefault();
        
        // é›™æŒ‡ç¸®æ”¾åµæ¸¬
        if(e.touches && e.touches.length === 2 && selectedIdx !== -1) {
            interactionMode = 'PINCH';
            initialPinchDist = getPinchDist(e);
            initialScale = elements[selectedIdx].size;
            return;
        }

        const p = getPointerPos(e);
        
        // æª¢æŸ¥æ‰‹æŸ„ (å¿…é ˆå…ˆæª¢æŸ¥ï¼Œä¸”åªé‡å°å·²é¸å–çš„)
        if(selectedIdx !== -1) {
            const el = elements[selectedIdx];
            // è½‰æ›é»æ“Šåº§æ¨™åˆ°ç‰©ä»¶å±€éƒ¨åº§æ¨™
            const dx = p.x - el.x; const dy = p.y - el.y;
            const rad = -el.rotation * Math.PI/180;
            const lx = dx*Math.cos(rad) - dy*Math.sin(rad);
            const ly = dx*Math.sin(rad) + dy*Math.cos(rad);
            
            const w = el._w, h = el._h;

            // æ—‹è½‰æ‰‹æŸ„ (0, -h/2-40)
            if(Math.hypot(lx - 0, ly - (-h/2-40)) < 30) {
                interactionMode = 'ROTATE';
                return;
            }
            // ç¸®æ”¾æ‰‹æŸ„ (w/2+10, h/2+10)
            if(Math.hypot(lx - (w/2+10), ly - (h/2+10)) < 30) {
                interactionMode = 'SCALE';
                dragStart = {size: el.size, dist: Math.hypot(lx, ly)};
                return;
            }
        }

        // æª¢æŸ¥æœ¬é«”
        let hit = -1;
        for(let i=elements.length-1; i>=0; i--) {
            const el = elements[i];
            const dx = p.x - el.x; const dy = p.y - el.y;
            // ç°¡å–®è·é›¢åˆ¤å®š (æ–‡å­—å¯¬ä¸€é»)
            const limit = Math.max(el._w, el._h)/1.5 + 20;
            if(Math.hypot(dx, dy) < limit) { hit = i; break; }
        }

        selectedIdx = hit;
        updateUI();
        renderCanvas();

        if(hit !== -1) {
            interactionMode = 'DRAG';
            dragStart = {x: p.x, y: p.y};
        } else {
            interactionMode = 'NONE';
        }
    }

    function onPointerMove(e) {
        if(interactionMode === 'NONE') return;
        e.preventDefault();

        // é›™æŒ‡ç¸®æ”¾
        if(interactionMode === 'PINCH' && e.touches && e.touches.length === 2) {
            const dist = getPinchDist(e);
            const scale = dist / initialPinchDist;
            elements[selectedIdx].size = initialScale * scale;
            renderCanvas();
            return;
        }

        const p = getPointerPos(e);
        const el = elements[selectedIdx];

        if(interactionMode === 'DRAG') {
            el.x += (p.x - dragStart.x);
            el.y += (p.y - dragStart.y);
            dragStart = {x: p.x, y: p.y};
        } 
        else if(interactionMode === 'ROTATE') {
            const dx = p.x - el.x;
            const dy = p.y - el.y;
            // è¨ˆç®—è§’åº¦ (+90åº¦å› ç‚ºæ‰‹æŸ„åœ¨ä¸Šæ–¹)
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            el.rotation = angle + 90;
        }
        else if(interactionMode === 'SCALE') {
            // æ»‘é¼ æ‹–æ›³ç¸®æ”¾æ‰‹æŸ„
            const dist = Math.hypot(p.x - el.x, p.y - el.y);
            // ç°¡å–®æ¯”ä¾‹æ”¾å¤§
            const ratio = dist / dragStart.dist;
            el.size = dragStart.size * ratio;
        }

        renderCanvas();
    }

    function onPointerUp(e) { interactionMode = 'NONE'; }

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function updateUI() {
        const panel = document.getElementById('object-controls');
        if(selectedIdx === -1) { panel.style.display='none'; return; }
        panel.style.display = 'block';
        const el = elements[selectedIdx];
        if(el.type==='text') {
            document.getElementById('text-edit-row').style.display='flex';
            document.getElementById('color-edit-row').style.display='flex';
            document.getElementById('edit-text-input').value = el.content;
            document.getElementById('edit-color-input').value = el.color;
        } else {
            document.getElementById('text-edit-row').style.display='none';
            document.getElementById('color-edit-row').style.display='none';
        }
    }

    function updateSelectedText(v) { if(selectedIdx!==-1){elements[selectedIdx].content=v; renderCanvas();}}
    function updateSelectedColor(v) { if(selectedIdx!==-1){elements[selectedIdx].color=v; renderCanvas();}}
    function deleteSelected() { if(selectedIdx!==-1){elements.splice(selectedIdx,1); selectedIdx=-1; updateUI(); renderCanvas();}}

    function addTextObject() { addElement({type:'text', content:'è«‹è¼¸å…¥æ–‡å­—', size:60, color:'#000000'}); }
    function addElement(props) {
        elements.push({x:canvas.width/2, y:canvas.height/2, rotation:0, ...props});
        selectedIdx=elements.length-1; updateUI(); renderCanvas();
    }
    
    function uploadBg(input) { if(input.files[0]) { const i=new Image(); i.onload=()=>{config.bgImg=i;config.bgType='image';renderCanvas();}; i.src=URL.createObjectURL(input.files[0]); } }
    function uploadSticker(input) { if(input.files[0]) { const i=new Image(); i.onload=()=>{addElement({type:'image', img:i, size:200});}; i.src=URL.createObjectURL(input.files[0]); } }

    function downloadImage() { selectedIdx=-1; renderCanvas(); const l=document.createElement('a'); l.download=`life4cuts-v5-${Date.now()}.png`; l.href=canvas.toDataURL(); l.click(); }
</script>
</body>
</html>
