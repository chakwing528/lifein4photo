<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿå››æ ¼ Pro | My Life4Cuts</title>
    <style>
        /* --- ç¶²ç«™åŸºæœ¬æ¨£å¼ --- */
        :root {
            --primary-color: #ff7eb3;
            --secondary-color: #8e44ad;
            --bg-color: #f4f4f9;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: var(--bg-color);
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h1 { margin-bottom: 5px; color: #444; }
        
        /* --- æ§åˆ¶é¢æ¿ --- */
        .panel {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-width: 800px;
            margin: 10px auto;
            text-align: center;
        }

        .btn {
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            background-color: #eee;
            color: #333;
            border: none;
            border-radius: 8px;
            margin: 5px;
            transition: 0.2s;
        }
        .btn:hover { filter: brightness(0.9); }
        .btn.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        .btn-xl { font-size: 18px; padding: 12px 30px; background: var(--secondary-color); color: white; }
        
        /* --- è‡ªè¨‚èƒŒæ™¯èˆ‡ç‰¹æ•ˆå€ --- */
        .custom-section { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 10px; }
        .control-group { border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .control-title { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        
        input[type="color"] { cursor: pointer; height: 35px; width: 50px; border: none; padding: 0; }
        input[type="file"] { font-size: 12px; }

        /* --- ç›¸æ©Ÿèˆ‡é è¦½ --- */
        #camera-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            border: 4px solid #333;
            border-radius: 8px;
            background: #000;
            overflow: hidden;
        }
        
        /* é—œéµä¿®æ­£ï¼šè®“ Video å¡«æ»¿å®¹å™¨ï¼Œä¸¦åˆ©ç”¨ CSS æ¨¡æ“¬ã€Œè£åˆ‡å¾Œã€çš„æ¨£å­ 
           é€™è£¡è¨­å®šä¸€å€‹å›ºå®šæ¯”ä¾‹å®¹å™¨ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ‹å‡ºä¾†å°±æ˜¯é€™å€‹ç¯„åœ
        */
        video {
            display: block;
            transform: scaleX(-1); /* é¡åƒ */
            /* è®“å½±ç‰‡å¡«æ»¿å®¹å™¨ï¼Œå¤šé¤˜çš„æœƒè¢«çˆ¶å±¤ overflow:hidden åˆ‡æ‰ (è¦–è¦ºé è¦½) */
            object-fit: cover; 
            width: 600px;
            height: 450px; /* 4:3 æ¯”ä¾‹ */
        }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 120px; color: white; font-weight: 900;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: none; pointer-events: none; z-index: 10;
        }

        /* --- çµæœå±•ç¤º --- */
        #result-area { display: none; margin-top: 20px; }
        canvas {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            height: auto;
            border-radius: 4px;
        }

        /* åˆ—å°æ¨¡å¼ */
        @media print {
            body * { visibility: hidden; }
            #result-area, #result-area canvas { visibility: visible; }
            #result-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; }
            canvas { width: 100%; max-height: 100vh; object-fit: contain; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <h1>ğŸ“¸ äººç”Ÿå››æ ¼ Pro</h1>
        
        <div class="panel">
            <div class="control-group">
                <span class="control-title">1. é¸æ“‡ç‰ˆå‹</span>
                <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (ç¶“å…¸é•·æ¢)</button>
                <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (å…©æ¢ä¸¦æ’)</button>
            </div>
            <br>
            <button class="btn btn-xl" onclick="startCapture()">âœ¨ é–‹å§‹æ‹æ” (é€£æ‹4å¼µ) âœ¨</button>
        </div>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline></video>
        <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            <h3>ğŸ¨ è£é£¾ä½ çš„ç…§ç‰‡</h3>
            <div class="custom-section">
                <div class="control-group">
                    <span class="control-title">æ›´æ”¹èƒŒæ™¯</span>
                    <button class="btn" onclick="setBgColor('#ffffff')">ç™½</button>
                    <button class="btn" onclick="setBgColor('#000000')">é»‘</button>
                    <button class="btn" onclick="setBgColor('#ffebf0')">ç²‰</button>
                    <label style="cursor:pointer; display:inline-block; margin-left:5px;">
                        ğŸ¨ è‡ªé¸è‰² <input type="color" id="color-picker" oninput="setBgColor(this.value)">
                    </label>
                    <div style="margin-top:5px;">
                        <span style="font-size:12px;">ğŸ–¼ï¸ ä¸Šå‚³èƒŒæ™¯åœ–:</span>
                        <input type="file" id="bg-upload" accept="image/*" onchange="uploadBackground(this)">
                    </div>
                </div>

                <div class="control-group">
                    <span class="control-title">æ·»åŠ ç‰¹æ•ˆ</span>
                    <button class="btn" onclick="toggleEffect('none')">ç„¡</button>
                    <button class="btn" onclick="toggleEffect('hearts')">â¤ï¸ å¿ƒå¿ƒé›¨</button>
                    <button class="btn" onclick="toggleEffect('stars')">âœ¨ é–ƒäº®äº®</button>
                    <button class="btn" onclick="toggleEffect('cats')">ğŸ± è²“å’ª</button>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-xl" onclick="downloadImage()">ğŸ“¥ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                <button class="btn" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
        </div>

        <canvas id="finalCanvas"></canvas>
    </div>

    <script>
        // --- è®Šæ•¸ ---
        const video = document.getElementById('video');
        const finalCanvas = document.getElementById('finalCanvas');
        const ctx = finalCanvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const resultArea = document.getElementById('result-area');
        const cameraWrapper = document.getElementById('camera-wrapper');

        let photos = []; // å­˜ 4 å¼µç…§ç‰‡
        let currentFormat = '2x6';
        
        // ç‹€æ…‹è®Šæ•¸ï¼šç”¨æ–¼å¾ŒæœŸè£½ä½œ
        let currentBgType = 'color'; // 'color' or 'image'
        let currentBgValue = '#ffebf0'; // é è¨­ç²‰è‰²èƒŒæ™¯
        let customBgImage = null; // å„²å­˜ä½¿ç”¨è€…ä¸Šå‚³çš„èƒŒæ™¯åœ–ç‰©ä»¶
        let currentEffect = 'none'; // ç‰¹æ•ˆ

        // --- 1. ç›¸æ©Ÿå•Ÿå‹•èˆ‡è¨­å®š ---
        // æˆ‘å€‘è¨­å®šç›¸æ©Ÿé è¦½æ¡†çš„å¤§å°ç‚º 600x450 (4:3)
        // é€™æœƒå¼·åˆ¶ä½¿ç”¨è€…çœ‹åˆ°çš„å°±æ˜¯æœ€çµ‚æœƒè¢«è£åˆ‡çš„ç¯„åœ
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 }, 
                height: { ideal: 720 },
                facingMode: "user" 
            } 
        }).then(stream => {
            video.srcObject = stream;
        }).catch(err => alert("ç›¸æ©ŸéŒ¯èª¤: " + err));

        // --- 2. æ‹æ”é‚è¼¯ ---
        function setFormat(fmt) {
            currentFormat = fmt;
            document.getElementById('btn-2x6').className = fmt === '2x6' ? 'btn active' : 'btn';
            document.getElementById('btn-4x6').className = fmt === '4x6' ? 'btn active' : 'btn';
            if(photos.length === 4) renderFinalImage(); // å¦‚æœå·²ç¶“æ‹å®Œï¼Œåˆ‡æ›å°ºå¯¸æ™‚ç›´æ¥é‡ç¹ª
        }

        async function startCapture() {
            photos = [];
            resultArea.style.display = 'none';
            cameraWrapper.scrollIntoView({ behavior: 'smooth' });

            for (let i = 1; i <= 4; i++) {
                await runCountdown(3);
                capturePhoto();
            }
            // æ‹å®Œå¾Œç¬¬ä¸€æ¬¡æ¸²æŸ“
            resultArea.style.display = 'block';
            renderFinalImage();
            location.href = "#result-area";
        }

        function runCountdown(sec) {
            return new Promise(resolve => {
                countdownEl.style.display = 'block';
                let c = sec;
                countdownEl.innerText = c;
                let timer = setInterval(() => {
                    c--;
                    if(c > 0) countdownEl.innerText = c;
                    else {
                        clearInterval(timer);
                        countdownEl.style.display = 'none';
                        resolve();
                    }
                }, 1000);
            });
        }

        // --- é—œéµä¿®æ­£ï¼šæ™ºæ…§è£åˆ‡æ‹ç…§ ---
        function capturePhoto() {
            const tempCanvas = document.createElement('canvas');
            // æˆ‘å€‘å¸Œæœ›ç…§ç‰‡æœ€çµ‚æ˜¯ 4:3 æ¯”ä¾‹ (ä¾‹å¦‚ 800x600)
            const targetW = 800;
            const targetH = 600;
            tempCanvas.width = targetW;
            tempCanvas.height = targetH;
            const tCtx = tempCanvas.getContext('2d');

            // é¡åƒè™•ç†
            tCtx.translate(targetW, 0);
            tCtx.scale(-1, 1);

            // è¨ˆç®—è£åˆ‡åƒæ•¸ (æ¨¡ä»¿ object-fit: cover)
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const videoRatio = vw / vh;
            const targetRatio = targetW / targetH;
            
            let sx, sy, sw, sh;

            if (videoRatio > targetRatio) {
                // è¦–è¨Šæ¯”è¼ƒå¯¬ -> è£æ‰å·¦å³
                sh = vh;
                sw = vh * targetRatio;
                sy = 0;
                sx = (vw - sw) / 2; // å–ä¸­é–“
            } else {
                // è¦–è¨Šæ¯”è¼ƒé«˜ -> è£æ‰ä¸Šä¸‹
                sw = vw;
                sh = vw / targetRatio;
                sx = 0;
                sy = (vh - sh) / 2;
            }

            // drawImage(source, sx, sy, sw, sh, dx, dy, dw, dh)
            // åªæŠ“å–è¦–è¨Šä¸­é–“çš„éƒ¨åˆ†ï¼Œç•«æ»¿æ•´å€‹ canvas
            tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
            
            photos.push(tempCanvas);
            
            // é–ƒå…‰æ•ˆæœ
            document.body.style.backgroundColor = 'white';
            setTimeout(() => document.body.style.backgroundColor = '', 100);
        }

        // --- 3. å¾ŒæœŸè£½ä½œåŠŸèƒ½ (èƒŒæ™¯ & ç‰¹æ•ˆ) ---

        function setBgColor(color) {
            currentBgType = 'color';
            currentBgValue = color;
            if(photos.length === 4) renderFinalImage();
        }

        function uploadBackground(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        customBgImage = img;
                        currentBgType = 'image';
                        if(photos.length === 4) renderFinalImage();
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleEffect(effectName) {
            currentEffect = effectName;
            if(photos.length === 4) renderFinalImage();
        }

        // --- 4. æœ€çµ‚æ¸²æŸ“ (æ ¸å¿ƒç¹ªåœ–é‚è¼¯) ---
        // é€™å€‹å‡½æ•¸ç¾åœ¨å¯ä»¥è¢«é‡è¤‡å‘¼å« (æ›èƒŒæ™¯ã€æ›ç‰¹æ•ˆæ™‚)
        function renderFinalImage() {
            // åƒæ•¸è¨­å®š (åŸºç¤å–®ä½)
            const photoW = 800;
            const photoH = 600; 
            const padding = 50;
            const headerH = 100;
            const footerH = 250;
            
            // è¨ˆç®—ç•«å¸ƒå°ºå¯¸
            const stripW = photoW + (padding * 2);
            const stripH = headerH + (photoH * 4) + (padding * 5) + footerH;

            let finalW, finalH;
            if (currentFormat === '2x6') {
                finalW = stripW;
                finalH = stripH;
            } else {
                finalW = stripW * 2;
                finalH = stripH;
            }

            finalCanvas.width = finalW;
            finalCanvas.height = finalH;

            // --- A. ç¹ªè£½èƒŒæ™¯ ---
            if (currentBgType === 'color') {
                ctx.fillStyle = currentBgValue;
                ctx.fillRect(0, 0, finalW, finalH);
            } else if (currentBgType === 'image' && customBgImage) {
                // èƒŒæ™¯åœ–æ¨¡å¼ (é¡ä¼¼ cover å¡«æ»¿)
                drawCoverImage(ctx, customBgImage, finalW, finalH);
            }

            // --- B. ç¹ªè£½ç…§ç‰‡æ¢ ---
            function drawOneStrip(offsetX) {
                // ç•«æ¯å¼µç…§ç‰‡
                photos.forEach((p, i) => {
                    const x = offsetX + padding;
                    const y = headerH + padding + (i * (photoH + padding));
                    
                    // ç…§ç‰‡ç™½é‚Š/é™°å½±
                    ctx.fillStyle = "white";
                    ctx.fillRect(x - 10, y - 10, photoW + 20, photoH + 20);
                    
                    // ç•«ç…§ç‰‡
                    ctx.drawImage(p, x, y, photoW, photoH);

                    // --- C. ç¹ªè£½ç‰¹æ•ˆ (é‡å°æ¯å¼µç…§ç‰‡) ---
                    drawEffects(x, y, photoW, photoH);
                });

                // åº•éƒ¨æ–‡å­—
                ctx.fillStyle = "#333";
                // å¦‚æœèƒŒæ™¯æ˜¯æ·±è‰²ï¼Œæ–‡å­—æ”¹ç™½è‰²
                if(currentBgValue === '#000000') ctx.fillStyle = "#fff";
                
                ctx.font = "bold 60px Arial";
                ctx.textAlign = "center";
                ctx.fillText("LIFE4CUTS", offsetX + stripW/2, finalH - 120);
                
                ctx.font = "30px Arial";
                ctx.fillText(new Date().toLocaleDateString(), offsetX + stripW/2, finalH - 60);
            }

            if (currentFormat === '2x6') {
                drawOneStrip(0);
            } else {
                drawOneStrip(0);
                drawOneStrip(stripW);
                // ä¸­é–“è™›ç·š
                ctx.beginPath();
                ctx.setLineDash([20, 20]);
                ctx.moveTo(stripW, 0);
                ctx.lineTo(stripW, finalH);
                ctx.strokeStyle = "#ccc";
                ctx.lineWidth = 4;
                ctx.stroke();
            }
        }

        // è¼”åŠ©ï¼šç¹ªè£½ç‰¹æ•ˆ
        function drawEffects(x, y, w, h) {
            if (currentEffect === 'hearts') {
                ctx.font = "80px Arial";
                ctx.fillText("â¤ï¸", x + 40, y + 80); // å·¦ä¸Š
                ctx.fillText("â¤ï¸", x + w - 40, y + h - 40); // å³ä¸‹
            } else if (currentEffect === 'stars') {
                ctx.font = "80px Arial";
                ctx.fillText("âœ¨", x + 20, y + 60);
                ctx.fillText("âœ¨", x + w - 50, y + 60);
            } else if (currentEffect === 'cats') {
                ctx.font = "80px Arial";
                ctx.fillText("ğŸ±", x + 10, y + h - 20);
            }
        }

        // è¼”åŠ©ï¼šèƒŒæ™¯åœ–å¡«æ»¿ (Object-fit: cover æ¼”ç®—æ³•)
        function drawCoverImage(ctx, img, w, h) {
            const imgRatio = img.width / img.height;
            const canvasRatio = w / h;
            let sx, sy, sw, sh;
            
            if (imgRatio > canvasRatio) {
                sh = img.height;
                sw = img.height * canvasRatio;
                sy = 0;
                sx = (img.width - sw) / 2;
            } else {
                sw = img.width;
                sh = img.width / canvasRatio;
                sx = 0;
                sy = (img.height - sh) / 2;
            }
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `life4cuts-${Date.now()}.png`;
            link.href = finalCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
