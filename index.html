<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Life4Cuts éŸ“ç³»æ‹è²¼æ©Ÿ</title>
    <style>
        /* --- ğŸ¨ 1. æ•´é«”è¦–è¦ºè¨­è¨ˆ (Visual Design) --- */
        :root {
            --primary: #ff8fab;    /* éŸ“ç³»æŸ”ç²‰ */
            --primary-dark: #fb6f92;
            --accent: #a2d2ff;     /* æŸ”ç²‰è— */
            --bg-body: #fff0f5;    /* æ·ºç²‰èƒŒæ™¯ */
            --text-main: #594a4e;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px; /* æ‰‹æ©Ÿç‰ˆç•™é‚Šè· */
            text-align: center;
            /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ–°æ•´ç†å½±éŸ¿é«”é©— */
            overscroll-behavior-y: none; 
        }

        h1 {
            color: var(--primary-dark);
            font-size: 24px;
            margin: 10px 0;
            letter-spacing: 1px;
        }

        /* --- ğŸ“± 2. æ‰‹æ©Ÿç‰ˆé¢å®¹å™¨ (Responsive Container) --- */
        .app-container {
            max-width: 600px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé›»è…¦ç‰ˆä¹Ÿä¸æœƒå¤ªå¯¬ */
            margin: 0 auto;
            padding-bottom: 50px;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px); /* ç£¨ç ‚ç»ç’ƒè³ªæ„Ÿ */
            border: 1px solid rgba(255,255,255,0.8);
        }

        /* --- ğŸ”˜ 3. ç²¾ç·»æŒ‰éˆ•æ¨£å¼ (Buttons) --- */
        .btn {
            border: none;
            padding: 10px 18px;
            border-radius: 50px; /* è† å›Šç‹€ */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: #f0f0f0;
            color: #666;
            margin: 4px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            /* é˜²æ­¢æ‰‹æ©Ÿé»æ“Šåç™½ */
            -webkit-tap-highlight-color: transparent; 
        }

        .btn:active { transform: scale(0.95); }

        .btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 143, 171, 0.4);
        }

        .btn-xl {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin: 10px 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 6px 15px rgba(251, 111, 146, 0.4);
        }

        /* --- ğŸ“¹ 4. ç›¸æ©Ÿèˆ‡é è¦½ (Camera) --- */
        #camera-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            aspect-ratio: 3/4; /* å¼·åˆ¶ç›´å¼æ¯”ä¾‹ï¼Œé©åˆæ‰‹æ©Ÿè‡ªæ‹ */
            margin-bottom: 20px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«æ»¿å®¹å™¨ */
            transform: scaleX(-1); /* é¡åƒ */
        }

        #countdown {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            color: white;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: none;
            z-index: 10;
        }

        /* --- ğŸ–¼ï¸ 5. çµæœå€ (Result) --- */
        #result-area { display: none; }
        
        canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        /* --- ğŸ›ï¸ 6. æ§åˆ¶é …ç¾¤çµ„ (Input Groups) --- */
        .control-section {
            text-align: left;
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* ç¾åŒ–è¼¸å…¥æ¡† */
        input[type="text"] {
            width: 100%;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            outline: none;
            color: var(--text-main);
            background: #fafafa;
        }
        input[type="text"]:focus { border-color: var(--accent); background: white; }

        input[type="color"] {
            border: none; width: 40px; height: 40px; cursor: pointer; background: none;
        }

        /* åˆ—å°æ¨¡å¼éš±è— */
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .no-print, h1, .panel { display: none !important; }
            #result-area { display: block !important; position: absolute; top:0; left:0; width:100%; }
            canvas { box-shadow: none; width: 100%; max-height: 100vh; object-fit: contain; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1 class="no-print">â˜ï¸ Life4Cuts</h1>

    <div id="setup-panel" class="panel no-print">
        <div class="control-section">
            <span class="section-title">1. ç‰ˆå‹å°ºå¯¸</span>
            <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
            <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>
        </div>

        <div class="control-section">
            <span class="section-title">2. å€’æ•¸ç§’æ•¸</span>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
                <button class="btn active" id="default-timer" onclick="setTimer(5, this)">5ç§’</button>
                <button class="btn" onclick="setTimer(10, this)">10ç§’</button>
            </div>
        </div>

        <button class="btn btn-xl" onclick="startCapture()">ğŸ“¸ é–‹å§‹æ‹æ”</button>
        <p style="font-size:12px; color:#999;">*è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼Œæ”¯æ´ iPhone/Android</p>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline muted></video> <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            <div class="control-section">
                <span class="section-title">ğŸ¨ èƒŒæ™¯é¡è‰² / åœ–ç‰‡</span>
                <div style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                    <button class="btn" style="background:#fff; border:1px solid #ddd;" onclick="setBgColor('#ffffff')">ç™½</button>
                    <button class="btn" style="background:#000; color:#fff;" onclick="setBgColor('#000000')">é»‘</button>
                    <button class="btn" style="background:#ffebf0;" onclick="setBgColor('#ffebf0')">ç²‰</button>
                    <button class="btn" style="background:#e0f7fa;" onclick="setBgColor('#e0f7fa')">è—</button>
                    <input type="color" oninput="setBgColor(this.value)">
                </div>
                <div style="margin-top:8px;">
                    <label class="btn" style="font-size:12px; padding:5px 10px;">
                        ğŸ“‚ ä¸Šå‚³èƒŒæ™¯åœ–
                        <input type="file" accept="image/*" onchange="uploadBackground(this)" style="display:none;">
                    </label>
                </div>
            </div>

            <div class="control-section">
                <span class="section-title">âœ¨ ç‰¹æ•ˆ & è²¼åœ–</span>
                <button class="btn" onclick="toggleEffect('none')">ç„¡</button>
                <button class="btn" onclick="toggleEffect('hearts')">â¤ï¸</button>
                <button class="btn" onclick="toggleEffect('stars')">âœ¨</button>
                <button class="btn" onclick="toggleEffect('bear')">ğŸ»</button>
                <button class="btn" onclick="toggleEffect('crayon')">ğŸ–ï¸</button>
                <label class="btn" style="background:#fff3cd;">
                    ğŸ“‚ ä¸Šå‚³å¡é€šè²¼åœ–
                    <input type="file" accept="image/png" onchange="uploadSticker(this)" style="display:none;">
                </label>
            </div>

            <div class="control-section">
                <span class="section-title">âœï¸ æ–‡å­—èˆ‡æ—¥æœŸ (è‡ªç”±ä¿®æ”¹)</span>
                <input type="text" id="footer-text" value="MY LIFE 4 CUTS" placeholder="è¼¸å…¥åº•éƒ¨æ–‡å­—" oninput="renderFinalImage()" style="margin-bottom: 8px;">
                <input type="text" id="date-text" placeholder="è¼¸å…¥æ—¥æœŸ (æˆ–ç•™ç©º)" oninput="renderFinalImage()">
            </div>

            <div style="display: flex; gap:10px;">
                <button class="btn btn-xl" style="background: #333;" onclick="downloadImage()">â¬‡ ä¸‹è¼‰</button>
                <button class="btn btn-xl" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
            <div style="margin-top:5px;">
                 <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ¨¡å¼</button>
            </div>
        </div>

        <canvas id="finalCanvas"></canvas>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const video = document.getElementById('video');
    const finalCanvas = document.getElementById('finalCanvas');
    const ctx = finalCanvas.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    
    // ç‹€æ…‹
    let photos = [];
    let currentFormat = '2x6';
    let timerSeconds = 5;
    
    // è£é£¾ç‹€æ…‹
    let bgType = 'color'; // 'color' or 'image'
    let bgValue = '#ffebf0'; 
    let customBgImg = null;
    let effectType = 'none';
    let customStickerImg = null;

    // --- 1. åˆå§‹åŒ–ï¼šç›¸æ©Ÿ (iPhone å„ªåŒ–) ---
    // ä½¿ç”¨ environment é‚„æ˜¯ user é¡é ­ï¼Ÿé€™è£¡å„ªå…ˆä½¿ç”¨å‰é¡é ­ (user)
    const constraints = {
        audio: false,
        video: {
            facingMode: "user", // å‰é¡é ­
            width: { ideal: 1280 },
            height: { ideal: 960 } // 4:3 æ¯”ä¾‹
        }
    };

    navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            video.srcObject = stream;
            // é å…ˆå¡«å…¥ä»Šå¤©æ—¥æœŸ
            const today = new Date();
            document.getElementById('date-text').value = today.toLocaleDateString() + " " + today.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        })
        .catch(err => {
            console.error(err);
            alert("âš ï¸ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿã€‚è‹¥ä½¿ç”¨ iPhoneï¼Œè«‹ç¢ºä¿ç”¨ Safari é–‹å•Ÿä¸¦æŒ‰ã€Œå…è¨±ã€ã€‚");
        });

    // --- 2. è¨­å®šåŠŸèƒ½ ---
    function setFormat(fmt) {
        currentFormat = fmt;
        document.querySelectorAll('#setup-panel .control-section:nth-child(1) .btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+fmt).classList.add('active');
        if(photos.length === 4) renderFinalImage();
    }

    function setTimer(sec, btn) {
        timerSeconds = sec;
        btn.parentNode.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // --- 3. æ‹æ”æµç¨‹ ---
    async function startCapture() {
        photos = [];
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('result-area').style.display = 'none';
        
        // æ»¾å‹•åˆ°ç›¸æ©Ÿ
        document.getElementById('camera-wrapper').scrollIntoView({behavior:'smooth'});

        for(let i=1; i<=4; i++) {
            await runCountdown(timerSeconds);
            capturePhoto();
        }

        // æ‹å®Œè™•ç†
        document.getElementById('result-area').style.display = 'block';
        renderFinalImage();
        // éš±è—ç›¸æ©Ÿé è¦½ï¼Œå°ˆæ³¨åœ¨çµæœ
        document.getElementById('camera-wrapper').style.display = 'none';
        location.href = "#result-area";
    }

    function runCountdown(sec) {
        return new Promise(resolve => {
            countdownEl.style.display = 'block';
            let c = sec;
            countdownEl.innerText = c;
            let timer = setInterval(() => {
                c--;
                if(c > 0) countdownEl.innerText = c;
                else {
                    clearInterval(timer);
                    countdownEl.style.display = 'none';
                    resolve();
                }
            }, 1000);
        });
    }

    // æ™ºèƒ½è£åˆ‡æ‹ç…§ (ä¿æŒ 4:3 æ¯”ä¾‹ä¸è®Šå½¢)
    function capturePhoto() {
        const tempC = document.createElement('canvas');
        const w = 800;
        const h = 600; // 4:3
        tempC.width = w;
        tempC.height = h;
        const tCtx = tempC.getContext('2d');
        
        // é¡åƒ
        tCtx.translate(w, 0);
        tCtx.scale(-1, 1);

        // è¨ˆç®—è£åˆ‡
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const rRatio = w/h;
        const vRatio = vw/vh;
        let sx, sy, sw, sh;

        if(vRatio > rRatio) {
            sh = vh; sw = vh * rRatio; sy = 0; sx = (vw-sw)/2;
        } else {
            sw = vw; sh = vw / rRatio; sx = 0; sy = (vh-sh)/2;
        }

        tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
        photos.push(tempC);

        // é–ƒå…‰ç‰¹æ•ˆ
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top=0; flash.style.left=0; flash.style.width='100%'; flash.style.height='100%';
        flash.style.background='white'; flash.style.zIndex='999';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 100);
    }

    // --- 4. è£é£¾åŠŸèƒ½ ---
    function setBgColor(val) {
        bgType = 'color';
        bgValue = val;
        renderFinalImage();
    }
    
    function uploadBackground(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    customBgImg = img;
                    bgType = 'image';
                    renderFinalImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function toggleEffect(eff) {
        effectType = eff;
        renderFinalImage();
    }

    function uploadSticker(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    customStickerImg = img;
                    toggleEffect('custom');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 5. æœ€çµ‚åˆæˆæ¸²æŸ“ (Canvas) ---
    function renderFinalImage() {
        if(photos.length < 4) return;

        // åƒæ•¸è¨­å®š
        const photoW = 800;
        const photoH = 600;
        const padding = 50;
        const headerH = 80;
        const footerH = 350; // åº•éƒ¨ç•™ç©ºé–“çµ¦å…©è¡Œæ–‡å­—

        const stripW = photoW + (padding*2);
        const stripH = headerH + (photoH*4) + (padding*5) + footerH;

        let finalW = (currentFormat === '2x6') ? stripW : stripW*2;
        let finalH = stripH;

        finalCanvas.width = finalW;
        finalCanvas.height = finalH;

        // A. ç•«èƒŒæ™¯
        if(bgType === 'color') {
            ctx.fillStyle = bgValue;
            ctx.fillRect(0, 0, finalW, finalH);
        } else if (bgType === 'image' && customBgImg) {
            // èƒŒæ™¯åœ– Cover æ¨¡å¼
            const iRatio = customBgImg.width / customBgImg.height;
            const cRatio = finalW / finalH;
            let sx, sy, sw, sh;
            if(iRatio > cRatio) {
                sh = customBgImg.height; sw = sh * cRatio; sy=0; sx=(customBgImg.width-sw)/2;
            } else {
                sw = customBgImg.width; sh = sw / cRatio; sx=0; sy=(customBgImg.height-sh)/2;
            }
            ctx.drawImage(customBgImg, sx, sy, sw, sh, 0, 0, finalW, finalH);
        }

        // B. ç•«ç…§ç‰‡æ¢
        function drawStrip(offsetX) {
            photos.forEach((p, i) => {
                const x = offsetX + padding;
                const y = headerH + padding + (i * (photoH + padding));
                
                // ç™½æ¡†
                ctx.fillStyle = "white";
                ctx.fillRect(x-15, y-15, photoW+30, photoH+30);
                
                // ç…§ç‰‡
                ctx.drawImage(p, x, y, photoW, photoH);

                // ç‰¹æ•ˆ
                drawEffects(x, y, photoW, photoH, i);
            });

            // C. åº•éƒ¨æ–‡å­— (ä½¿ç”¨è¼¸å…¥æ¡†çš„å€¼)
            ctx.textAlign = "center";
            const textColor = (bgValue === '#000000') ? "#fff" : "#444";
            ctx.fillStyle = textColor;
            
            // ä¸»æ¨™é¡Œ
            const text1 = document.getElementById('footer-text').value;
            ctx.font = "bold 60px 'Segoe UI', Arial";
            ctx.fillText(text1, offsetX + stripW/2, finalH - 180);

            // æ—¥æœŸæ™‚é–“ (å‰¯æ¨™é¡Œ)
            const text2 = document.getElementById('date-text').value;
            ctx.font = "30px 'Segoe UI', Arial";
            ctx.fillText(text2, offsetX + stripW/2, finalH - 100);
        }

        if(currentFormat === '2x6') {
            drawStrip(0);
        } else {
            drawStrip(0);
            drawStrip(stripW);
            // åˆ‡å‰²ç·š
            ctx.beginPath();
            ctx.setLineDash([20, 20]);
            ctx.moveTo(stripW, 0);
            ctx.lineTo(stripW, finalH);
            ctx.strokeStyle = "rgba(150,150,150,0.5)";
            ctx.lineWidth = 4;
            ctx.stroke();
        }
    }

    function drawEffects(x, y, w, h, i) {
        if(effectType === 'none') return;
        
        // è®“è²¼åœ–æœ‰é»éš¨æ©Ÿæ„Ÿ
        const offset = (i % 2 === 0) ? 0 : 30;
        
        ctx.font = "80px Arial";
        if(effectType === 'hearts') {
            ctx.fillText("â¤ï¸", x+20, y+80);
            ctx.fillText("ğŸ¥°", x+w-80, y+h-20);
        } else if(effectType === 'stars') {
            ctx.fillText("âœ¨", x+20+offset, y+80);
            ctx.fillText("ğŸ’«", x+w-80-offset, y+h-30);
        } else if(effectType === 'bear') {
            ctx.fillText("ğŸ§¸", x+w-90, y+h-20);
        } else if(effectType === 'crayon') {
             ctx.fillText("ğŸ–ï¸", x+20, y+80);
             ctx.fillText("ğŸŒˆ", x+w-80, y+h-20);
        } else if(effectType === 'custom' && customStickerImg) {
            // ç¹ªè£½ä¸Šå‚³çš„è²¼åœ–
            const sW = 180;
            const sH = (customStickerImg.height / customStickerImg.width) * sW;
            ctx.drawImage(customStickerImg, x + w - sW - 10, y + h - sH - 10, sW, sH);
        }
    }

    function downloadImage() {
        const link = document.createElement('a');
        link.download = `life4cuts-${Date.now()}.png`;
        link.href = finalCanvas.toDataURL('image/png', 1.0);
        link.click();
    }
</script>
</body>
</html>
