<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.2</title>
    <style>
        /* --- ğŸ¨ V.2 è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.25);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444;
            margin: 0;
            padding: 20px 10px;
            text-align: center;
            overscroll-behavior-y: none; /* é˜²æ­¢ä¸‹æ‹‰åˆ·æ–° */
            user-select: none;
            -webkit-user-select: none;
        }

        h1 { margin: 10px 0; color: var(--primary-dark); font-size: 20px; letter-spacing: 1px; }

        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* --- é¢æ¿æ¨£å¼ --- */
        .panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.8);
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            border: none; padding: 8px 16px; border-radius: 50px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            background: #f0f0f0; color: #666; margin: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn.active { background: var(--primary); color: white; }
        
        .btn-xl {
            width: 100%; padding: 14px; font-size: 18px; margin-top: 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 12px rgba(251, 111, 146, 0.4);
        }

        /* --- ğŸ“· ç›¸æ©Ÿé è¦½ (ä¿®æ­£ç‰ˆ) --- */
        #camera-wrapper {
            position: relative;
            width: 100%;
            /* é—œéµä¿®æ­£ï¼šå¼·åˆ¶ 4:3 æ¯”ä¾‹ï¼Œè§£æ±ºç•«é¢å¤ªçª„å•é¡Œ */
            aspect-ratio: 4 / 3; 
            margin: 0 auto 20px auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: none;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«æ»¿ 4:3 å®¹å™¨ */
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }

        #countdown {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem; color: white; font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: none; z-index: 10;
        }

        /* --- Canvas ç·¨è¼¯å€ --- */
        #result-area { display: none; }
        
        .canvas-container {
            position: relative; width: 100%; margin-bottom: 15px;
            box-shadow: var(--shadow); border-radius: 8px; touch-action: none;
        }
        canvas { display: block; width: 100%; height: auto; }

        /* --- æ§åˆ¶é … --- */
        .section-title {
            font-size: 12px; color: #888; display: block; margin: 10px 0 5px; font-weight: bold;
        }
        
        /* è¼¸å…¥æ¡†ç¾åŒ– */
        input[type="text"] {
            width: 80%; padding: 10px; border: 2px solid #eee; border-radius: 10px; 
            text-align: center; font-size: 16px; margin-bottom: 5px;
            background: #fafafa;
        }

        /* è²¼åœ–ç¶²æ ¼ */
        .sticker-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 5px;
        }
        .sticker-btn {
            background: #fff; border: 1px solid #eee; font-size: 22px; padding: 5px; 
            border-radius: 8px; cursor: pointer;
        }

        /* å°ºå¯¸æ»‘æ¡¿æ§åˆ¶å€ (é è¨­éš±è—ï¼Œé¸ä¸­è²¼åœ–æ‰é¡¯ç¤º) */
        #size-control-panel {
            background: #fff3cd; padding: 10px; border-radius: 10px; margin-top: 10px; display: none;
        }
        input[type=range] { width: 80%; vertical-align: middle; }

        @media print {
            .no-print, .panel { display: none !important; }
            #result-area { display: block !important; position: absolute; top:0; left:0; width:100%; }
            canvas { width: 100%; height: 100%; object-fit: contain; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1 class="no-print">ğŸ“¸ äººç”Ÿå››æ ¼ V.2</h1>

    <div id="setup-panel" class="panel no-print">
        <div class="section-title">ç‰ˆå‹å°ºå¯¸</div>
        <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
        <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>

        <div class="section-title">å€’æ•¸ç§’æ•¸</div>
        <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
        <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
        <button class="btn" onclick="setTimer(10, this)">10ç§’</button>

        <button class="btn btn-xl" onclick="startCameraProcess()">ğŸ“¸ é–‹å•Ÿé¡é ­ä¸¦æ‹æ”</button>
        <p style="font-size:11px; color:#aaa; margin-top:5px;">(æ‹æ”å®Œæˆå¾Œé¡é ­å°‡è‡ªå‹•é—œé–‰)</p>
    </div>

    <div id="camera-wrapper" class="no-print">
        <video id="video" autoplay playsinline muted></video>
        <div id="countdown"></div>
    </div>

    <div id="result-area">
        <div class="panel no-print">
            
            <div class="section-title">ğŸ¨ èƒŒæ™¯è¨­å®š</div>
            <div style="display:flex; justify-content:center; gap:5px; flex-wrap:wrap;">
                <button class="btn" style="background:#fff; border:1px solid #ddd;" onclick="setBgColor('#ffffff')">ç™½</button>
                <button class="btn" style="background:#222; color:#fff;" onclick="setBgColor('#000000')">é»‘</button>
                <button class="btn" style="background:#ffebf0;" onclick="setBgColor('#ffebf0')">ç²‰</button>
                <input type="color" oninput="setBgColor(this.value)" style="width:40px; height:30px; border:none; background:none;">
            </div>
            <label class="btn" style="margin-top:5px; display:inline-block; width:80%; background:#e3f2fd; color:#0d47a1;">
                ğŸ“‚ ä¸Šå‚³èƒŒæ™¯ç…§ç‰‡
                <input type="file" accept="image/*" onchange="uploadBackground(this)" style="display:none;">
            </label>

            <div class="section-title">âœï¸ æ–‡å­—èˆ‡æ—¥æœŸ (å¯è‡ªç”±ä¿®æ”¹)</div>
            <input type="text" id="footer-text" value="MY LIFE 4 CUTS" oninput="redrawAll()">
            <input type="text" id="date-text" placeholder="è¼¸å…¥æ—¥æœŸæ™‚é–“" oninput="redrawAll()">

            <div class="section-title">âœ¨ æ·»åŠ ç‰¹æ•ˆ (å¯æ‹–æ›³ã€é»é¸èª¿æ•´å¤§å°)</div>
            <div class="sticker-grid">
                <button class="sticker-btn" onclick="addEmojiSticker('â¤ï¸')">â¤ï¸</button>
                <button class="sticker-btn" onclick="addEmojiSticker('âœ¨')">âœ¨</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ€')">ğŸ€</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ±')">ğŸ±</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ¶')">ğŸ¶</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ”¥')">ğŸ”¥</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ‘‘')">ğŸ‘‘</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸ•¶ï¸')">ğŸ•¶ï¸</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸŒˆ')">ğŸŒˆ</button>
                <button class="sticker-btn" onclick="addEmojiSticker('ğŸŒ¸')">ğŸŒ¸</button>
            </div>
            <label class="btn" style="margin-top:5px; font-size:12px;">
                ğŸ“‚ ä¸Šå‚³è²¼åœ– (PNG)
                <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
            </label>

            <div id="size-control-panel">
                <span style="font-size:12px; font-weight:bold; color:#856404;">ğŸ“ èª¿æ•´é¸å–è²¼åœ–å¤§å°</span><br>
                <span style="font-size:20px;">â–</span>
                <input type="range" id="size-slider" min="50" max="400" step="10" oninput="resizeSelectedSticker(this.value)">
                <span style="font-size:20px;">â•</span>
                <div style="margin-top:5px;">
                    <button class="btn" style="background:#ff6b6b; color:white; font-size:12px;" onclick="deleteSelectedSticker()">ğŸ—‘ï¸ åˆªé™¤æ­¤è²¼åœ–</button>
                </div>
            </div>

            <div style="margin-top:20px; display: flex; gap:10px;">
                <button class="btn btn-xl" onclick="downloadImage()">â¬‡ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn btn-xl" style="background:#666;" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>
</div>

<script>
    // --- è®Šæ•¸å®£å‘Š ---
    const video = document.getElementById('video');
    const finalCanvas = document.getElementById('finalCanvas');
    const ctx = finalCanvas.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    const setupPanel = document.getElementById('setup-panel');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const resultArea = document.getElementById('result-area');
    const sizeControlPanel = document.getElementById('size-control-panel');
    const sizeSlider = document.getElementById('size-slider');

    let streamObj = null;
    let photos = [];
    let currentFormat = '2x6';
    let timerSeconds = 5;

    // ç·¨è¼¯ç‹€æ…‹
    let bgType = 'color'; // 'color' | 'image'
    let bgColor = '#ffebf0';
    let customBgImg = null;

    let stickers = []; 
    let selectedStickerIndex = -1; // ç•¶å‰é¸ä¸­çš„è²¼åœ–
    
    // æ‹–æ›³ç›¸é—œ
    let isDragging = false;
    let dragTargetIndex = -1;
    let lastMouseX, lastMouseY;

    // --- 1. ç›¸æ©Ÿæ§åˆ¶ ---
    
    async function startCameraProcess() {
        setupPanel.style.display = 'none';
        cameraWrapper.style.display = 'block';
        
        try {
            // è«‹æ±‚ç›¸æ©Ÿï¼šé€™è£¡å¯¬é«˜è¨­å®šä¸å½±éŸ¿ CSS é¡¯ç¤ºæ¯”ä¾‹ï¼ŒCSS å¼·åˆ¶ 4:3
            streamObj = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
            });
            video.srcObject = streamObj;
            
            // é å…ˆå¡«å…¥æ—¥æœŸ
            const now = new Date();
            document.getElementById('date-text').value = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            // ç­‰å¾…ç›¸æ©Ÿå°±ç·’
            await new Promise(r => setTimeout(r, 1000));
            startCaptureLoop();
        } catch (err) {
            alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™");
            location.reload();
        }
    }

    function stopCamera() {
        if (streamObj) {
            streamObj.getTracks().forEach(track => track.stop());
            streamObj = null;
        }
        cameraWrapper.style.display = 'none';
    }

    // --- 2. æ‹æ”æµç¨‹ ---
    function setFormat(fmt) {
        currentFormat = fmt;
        document.getElementById('btn-2x6').classList.remove('active');
        document.getElementById('btn-4x6').classList.remove('active');
        document.getElementById('btn-'+fmt).classList.add('active');
    }

    function setTimer(sec, btn) {
        timerSeconds = sec;
        btn.parentNode.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function startCaptureLoop() {
        photos = [];
        cameraWrapper.scrollIntoView({behavior:'smooth'});

        for(let i=1; i<=4; i++) {
            await runCountdown(timerSeconds);
            capturePhoto();
        }
        stopCamera();
        resultArea.style.display = 'block';
        initCanvasEditor();
    }

    function runCountdown(sec) {
        return new Promise(resolve => {
            countdownEl.style.display = 'block';
            let c = sec;
            countdownEl.innerText = c;
            let timer = setInterval(() => {
                c--;
                if(c > 0) countdownEl.innerText = c;
                else {
                    clearInterval(timer);
                    countdownEl.style.display = 'none';
                    resolve();
                }
            }, 1000);
        });
    }

    // é—œéµï¼šæ‹æ”å°ºå¯¸å¿…é ˆä¹Ÿæ˜¯ 4:3 (800x600)
    function capturePhoto() {
        const tempC = document.createElement('canvas');
        const w = 800; 
        const h = 600; // 4:3 æ¯”ä¾‹
        tempC.width = w;
        tempC.height = h;
        const tCtx = tempC.getContext('2d');
        
        // å·¦å³é¡åƒç¿»è½‰
        tCtx.translate(w, 0);
        tCtx.scale(-1, 1);

        // è£åˆ‡é‚è¼¯ï¼šç¢ºä¿å’Œé è¦½æ¡†ä¸€æ¨£æ˜¯ 4:3
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const rRatio = w/h;
        const vRatio = vw/vh;
        let sx, sy, sw, sh;

        if(vRatio > rRatio) {
            sh = vh; sw = vh * rRatio; sy = 0; sx = (vw-sw)/2;
        } else {
            sw = vw; sh = vw / rRatio; sx = 0; sy = (vh-sh)/2;
        }
        tCtx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
        photos.push(tempC);

        // é–ƒå…‰
        const flash = document.createElement('div');
        flash.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;";
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 100);
    }

    // --- 3. ç•«å¸ƒç·¨è¼¯èˆ‡è²¼åœ–ç³»çµ± (V.2 é‡é») ---
    
    function initCanvasEditor() {
        redrawAll();
        
        // ç¶å®šè§¸æ§èˆ‡æ»‘é¼ äº‹ä»¶
        finalCanvas.addEventListener('mousedown', handlePointerDown);
        finalCanvas.addEventListener('touchstart', handlePointerDown, {passive: false});
        
        window.addEventListener('mousemove', handlePointerMove);
        window.addEventListener('touchmove', handlePointerMove, {passive: false});
        
        window.addEventListener('mouseup', handlePointerUp);
        window.addEventListener('touchend', handlePointerUp);
    }

    // é‡ç¹ªç•«é¢
    function redrawAll() {
        const photoW = 800;
        const photoH = 600;
        const padding = 50;
        const headerH = 80;
        const footerH = 350;

        const stripW = photoW + (padding*2);
        const stripH = headerH + (photoH*4) + (padding*5) + footerH;
        
        let finalW = (currentFormat === '2x6') ? stripW : stripW*2;
        let finalH = stripH;

        finalCanvas.width = finalW;
        finalCanvas.height = finalH;

        // 1. ç•«èƒŒæ™¯ (é¡è‰² æˆ– åœ–ç‰‡)
        if (bgType === 'image' && customBgImg) {
            // èƒŒæ™¯åœ– Object-fit: cover æ•ˆæœ
            const imgRatio = customBgImg.width / customBgImg.height;
            const canvasRatio = finalW / finalH;
            let sx, sy, sw, sh;
            if(imgRatio > canvasRatio) {
                sh = customBgImg.height; sw = sh * canvasRatio; sy = 0; sx = (customBgImg.width - sw) / 2;
            } else {
                sw = customBgImg.width; sh = sw / canvasRatio; sx = 0; sy = (customBgImg.height - sh) / 2;
            }
            ctx.drawImage(customBgImg, sx, sy, sw, sh, 0, 0, finalW, finalH);
        } else {
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, finalW, finalH);
        }

        // 2. ç•«ç…§ç‰‡æ¢
        drawPhotoStrip(0, stripW, finalH, photoW, photoH, headerH, padding);
        if (currentFormat === '4x6') {
            drawPhotoStrip(stripW, stripW, finalH, photoW, photoH, headerH, padding);
            // è™›ç·š
            ctx.beginPath();
            ctx.setLineDash([20, 20]);
            ctx.moveTo(stripW, 0);
            ctx.lineTo(stripW, finalH);
            ctx.strokeStyle = "rgba(150,150,150,0.5)";
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        // 3. ç•«è²¼åœ–
        ctx.setLineDash([]); 
        stickers.forEach((s, index) => {
            ctx.save();
            ctx.translate(s.x, s.y);
            
            // ç¹ªè£½è²¼åœ–å…§å®¹
            if(s.type === 'text') {
                ctx.font = `${s.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(s.content, 0, 0);
            } else if (s.type === 'image') {
                ctx.drawImage(s.content, -s.size/2, -(s.size * s.ratio)/2, s.size, s.size * s.ratio);
            }

            // å¦‚æœæ˜¯è¢«é¸ä¸­çš„è²¼åœ–ï¼Œç•«ç´…è‰²é¸å–æ¡†
            if (index === selectedStickerIndex) {
                ctx.strokeStyle = "red";
                ctx.lineWidth = 3;
                // ä¼°ç®—æ¡†çš„å¤§å°
                let boxSize = s.size;
                if (s.type === 'image') {
                    ctx.strokeRect(-boxSize/2 - 10, -(boxSize * s.ratio)/2 - 10, boxSize + 20, (boxSize * s.ratio) + 20);
                } else {
                    ctx.strokeRect(-boxSize/2 - 10, -boxSize/2 - 10, boxSize + 20, boxSize + 20);
                }
            }
            ctx.restore();
        });
    }

    function drawPhotoStrip(offsetX, stripW, stripH, pW, pH, headerH, pad) {
        // ç…§ç‰‡
        photos.forEach((p, i) => {
            const x = offsetX + pad;
            const y = headerH + pad + (i * (pH + pad));
            ctx.fillStyle = "white";
            ctx.fillRect(x-15, y-15, pW+30, pH+30);
            ctx.drawImage(p, x, y, pW, pH);
        });

        // åº•éƒ¨æ–‡å­—
        ctx.textAlign = 'center';
        // åˆ¤æ–·æ–‡å­—é¡è‰² (å¦‚æœèƒŒæ™¯æ˜¯é»‘çš„å°±ç”¨ç™½å­—)
        ctx.fillStyle = (bgType === 'color' && bgColor === '#000000') ? '#fff' : '#333';
        
        const txt1 = document.getElementById('footer-text').value;
        ctx.font = "bold 60px Arial";
        ctx.fillText(txt1, offsetX + stripW/2, stripH - 180);

        const txt2 = document.getElementById('date-text').value;
        ctx.font = "30px Arial";
        ctx.fillText(txt2, offsetX + stripW/2, stripH - 100);
    }

    // --- 4. äº’å‹•æ§åˆ¶ ---

    function setBgColor(c) { bgType='color'; bgColor = c; customBgImg = null; redrawAll(); }
    
    function uploadBackground(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    customBgImg = img;
                    bgType = 'image';
                    redrawAll();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // æ–°å¢è²¼åœ–
    function addEmojiSticker(emoji) {
        const newSticker = {
            type: 'text', content: emoji,
            x: finalCanvas.width / 2, y: finalCanvas.height / 2,
            size: 150
        };
        stickers.push(newSticker);
        selectSticker(stickers.length - 1); // è‡ªå‹•é¸ä¸­æ–°è²¼åœ–
        redrawAll();
    }

    function uploadSticker(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    stickers.push({
                        type: 'image', content: img,
                        x: finalCanvas.width / 2, y: finalCanvas.height / 2,
                        size: 200, ratio: img.height / img.width
                    });
                    selectSticker(stickers.length - 1);
                    redrawAll();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // é¸å–è²¼åœ–
    function selectSticker(index) {
        selectedStickerIndex = index;
        if (index !== -1) {
            sizeControlPanel.style.display = 'block';
            sizeSlider.value = stickers[index].size;
        } else {
            sizeControlPanel.style.display = 'none';
        }
    }

    // èª¿æ•´å¤§å°
    function resizeSelectedSticker(val) {
        if (selectedStickerIndex !== -1) {
            stickers[selectedStickerIndex].size = parseInt(val);
            redrawAll();
        }
    }

    function deleteSelectedSticker() {
        if (selectedStickerIndex !== -1) {
            stickers.splice(selectedStickerIndex, 1);
            selectedStickerIndex = -1;
            sizeControlPanel.style.display = 'none';
            redrawAll();
        }
    }

    // æ‹–æ›³é‚è¼¯
    function getPointerPos(e) {
        const rect = finalCanvas.getBoundingClientRect();
        const scaleX = finalCanvas.width / rect.width;
        const scaleY = finalCanvas.height / rect.height;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    function handlePointerDown(e) {
        e.preventDefault();
        const pos = getPointerPos(e);
        
        // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨æŸå€‹è²¼åœ–ä¸Š (åå‘éæ­·ï¼Œå…ˆé¸ä¸Šå±¤)
        let clickedIndex = -1;
        for (let i = stickers.length - 1; i >= 0; i--) {
            const s = stickers[i];
            const hitDist = s.size / 1.5;
            if (Math.abs(pos.x - s.x) < hitDist && Math.abs(pos.y - s.y) < hitDist) {
                clickedIndex = i;
                break;
            }
        }

        if (clickedIndex !== -1) {
            selectSticker(clickedIndex);
            isDragging = true;
            dragTargetIndex = clickedIndex;
            lastMouseX = pos.x;
            lastMouseY = pos.y;
            redrawAll();
        } else {
            // é»ç©ºç™½è™•å–æ¶ˆé¸å–
            selectSticker(-1);
            redrawAll();
        }
    }

    function handlePointerMove(e) {
        if (!isDragging || dragTargetIndex === -1) return;
        e.preventDefault();
        const pos = getPointerPos(e);
        const dx = pos.x - lastMouseX;
        const dy = pos.y - lastMouseY;

        stickers[dragTargetIndex].x += dx;
        stickers[dragTargetIndex].y += dy;

        lastMouseX = pos.x;
        lastMouseY = pos.y;
        redrawAll();
    }

    function handlePointerUp(e) {
        isDragging = false;
        dragTargetIndex = -1;
    }

    function downloadImage() {
        // å–æ¶ˆé¸å–æ¡†å†ä¸‹è¼‰
        const savedIndex = selectedStickerIndex;
        selectedStickerIndex = -1;
        redrawAll();
        
        const link = document.createElement('a');
        link.download = `life4cuts-v2-${Date.now()}.png`;
        link.href = finalCanvas.toDataURL('image/png');
        link.click();

        // æ¢å¾©é¸å–
        selectedStickerIndex = savedIndex;
        redrawAll();
    }
</script>
</body>
</html>
