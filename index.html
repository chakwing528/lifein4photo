<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ“¸ äººç”Ÿå››æ ¼ V.4</title>
    <style>
        /* --- ğŸ¨ V.4 è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #ff8fab;
            --primary-dark: #fb6f92;
            --bg-body: #fff0f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.25);
            --panel-width: 380px; /* é›»è…¦ç‰ˆå·¦å´å¯¬åº¦ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: #444;
            margin: 0; padding: 0;
            height: 100vh;
            overscroll-behavior: none; user-select: none; -webkit-user-select: none;
        }

        /* --- 1. å…¨è¢å¹•æ‹æ”æ¨¡å¼ (Fullscreen Camera) --- */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        #camera-wrapper {
            position: relative;
            width: 100%; max-width: 800px;
            /* ä¿æŒ 4:3 æ¯”ä¾‹ï¼Œä¸”ä¸è¶…éè¢å¹• */
            aspect-ratio: 4 / 3;
            overflow: hidden; box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }
        
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15vw; color: white; font-weight: 900;
            text-shadow: 0 5px 20px rgba(0,0,0,0.8); display: none;
        }

        /* --- 2. ç·¨è¼¯ä»‹é¢ä½ˆå±€ (Split Layout) --- */
        .app-container {
            display: flex; flex-direction: column; height: 100vh;
        }

        /* æ‹æ”å‰è¨­å®šé  */
        #setup-page {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px;
        }

        /* æ‹æ”å¾Œç·¨è¼¯é  (å·¦å³åˆ†å‰²) */
        #editor-page {
            display: none; height: 100%; width: 100%;
        }

        /* æ¡Œé¢ç‰ˆä½ˆå±€ï¼šå·¦å´æ§åˆ¶ï¼Œå³å´é è¦½ */
        @media (min-width: 768px) {
            #editor-page { flex-direction: row; }
            .editor-left {
                width: var(--panel-width); height: 100%; overflow-y: auto;
                background: white; border-right: 1px solid #eee; padding: 20px;
                box-sizing: border-box; box-shadow: 5px 0 15px rgba(0,0,0,0.05);
                z-index: 10;
            }
            .editor-right {
                flex: 1; height: 100%; background: #eee;
                display: flex; align-items: center; justify-content: center;
                padding: 40px; overflow: hidden;
            }
            canvas { 
                max-height: 90vh; max-width: 100%; 
                box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            }
        }

        /* æ‰‹æ©Ÿç‰ˆä½ˆå±€ï¼šä¸Šä¸‹æ’åˆ— */
        @media (max-width: 767px) {
            #editor-page { flex-direction: column-reverse; } /* æ§åˆ¶åœ¨ä¸‹ï¼Œåœ–åœ¨ä¸Š */
            .editor-left {
                width: 100%; height: 50%; overflow-y: auto;
                background: white; padding: 15px; box-sizing: border-box;
                border-top: 1px solid #eee;
            }
            .editor-right {
                width: 100%; height: 50%; background: #f4f4f4;
                display: flex; align-items: center; justify-content: center; padding: 10px;
            }
            canvas { max-height: 100%; max-width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        }

        /* --- UI å…ƒä»¶æ¨£å¼ --- */
        h1 { color: var(--primary-dark); margin-bottom: 20px; }
        
        .btn {
            border: none; padding: 10px 20px; border-radius: 50px; font-size: 14px; font-weight: 600;
            cursor: pointer; background: #f0f0f0; color: #666; margin: 5px; transition: 0.2s;
        }
        .btn.active { background: var(--primary); color: white; }
        .btn:active { transform: scale(0.95); }

        .btn-xl {
            width: 100%; padding: 16px; font-size: 18px; margin-top: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(251, 111, 146, 0.4);
        }

        .btn-print {
            background: #333; color: white; width: 100%; margin-top: 10px; padding: 14px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* å€å¡Šæ¨™é¡Œ */
        .section-header {
            font-size: 13px; font-weight: bold; color: #888; text-transform: uppercase;
            margin: 20px 0 10px 0; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }

        /* é¡è‰²é¸æ“‡å™¨ */
        .scroll-row { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; }
        .color-dot {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ddd; flex-shrink: 0; cursor: pointer;
        }
        
        /* è²¼åœ–ç¶²æ ¼ */
        .sticker-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
            max-height: 160px; overflow-y: auto; padding: 2px;
        }
        .sticker-item {
            font-size: 24px; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px;
            height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* é¸å–ç‰©ä»¶æ§åˆ¶å° */
        #object-controls {
            background: #fff8e1; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            border: 1px solid #ffe082; display: none;
        }
        .ctrl-row { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; font-size: 14px; }
        input[type=range] { flex: 1; }
        input[type=text] {
            flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; text-align: center;
        }

        /* åˆ—å°æ¨¡å¼ï¼šéš±è—æ‰€æœ‰UIï¼Œåªç•™ Canvas */
        @media print {
            body { background: white; height: auto; overflow: visible; }
            #setup-page, .editor-left, #camera-modal { display: none !important; }
            #editor-page { display: block !important; }
            .editor-right { background: white; padding: 0; width: 100%; height: auto; display: block; }
            canvas { 
                width: 100%; max-height: 100vh; object-fit: contain; box-shadow: none; margin: 0 auto; display: block;
            }
        }
    </style>
</head>
<body>

    <div id="setup-page" class="app-container">
        <h1>ğŸ“¸ äººç”Ÿå››æ ¼ V.4</h1>
        
        <div style="background:white; padding:30px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); width:100%; max-width:400px; box-sizing:border-box;">
            <div class="section-header">1. ç‰ˆå‹å°ºå¯¸</div>
            <div style="display:flex; justify-content:center;">
                <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 (æ›¸ç±¤)</button>
                <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 (ç›¸ç‰‡)</button>
            </div>

            <div class="section-header">2. å€’æ•¸ç§’æ•¸</div>
            <div style="display:flex; justify-content:center;">
                <button class="btn" onclick="setTimer(3, this)">3ç§’</button>
                <button class="btn active" onclick="setTimer(5, this)">5ç§’</button>
                <button class="btn" onclick="setTimer(10, this)">10ç§’</button>
            </div>

            <button class="btn-xl" onclick="startCamera()">ğŸš€ å…¨è¢å¹•æ‹æ”</button>
            <p style="font-size:12px; color:#999; text-align:center; margin-top:10px;">æ”¯æ´é›»è…¦èˆ‡æ‰‹æ©Ÿï¼Œæ‹æ”æ™‚è«‹çœ‹é¡é ­</p>
        </div>
    </div>

    <div id="camera-modal">
        <div id="camera-wrapper">
            <video id="video" autoplay playsinline muted></video>
            <div id="countdown"></div>
        </div>
        <div style="color:white; margin-top:20px; font-size:14px;">æ­£åœ¨æ‹æ”...è«‹ä¿æŒå¾®ç¬‘ ğŸ˜Š</div>
    </div>

    <div id="editor-page">
        
        <div class="editor-left">
            <h3>ğŸ¨ ç…§ç‰‡è£é£¾å°</h3>
            
            <div id="object-controls">
                <div style="font-weight:bold; margin-bottom:10px; color:#e65100;">âš¡ ç·¨è¼¯é¸å–é …ç›®</div>
                
                <div id="text-edit-row" class="ctrl-row">
                    <span>å…§å®¹</span>
                    <input type="text" id="edit-text-input" oninput="updateSelectedText(this.value)">
                </div>
                <div id="color-edit-row" class="ctrl-row">
                    <span>é¡è‰²</span>
                    <input type="color" id="edit-color-input" oninput="updateSelectedColor(this.value)">
                </div>

                <div class="ctrl-row">
                    <span>å¤§å°</span>
                    <input type="range" id="size-slider" min="20" max="400" step="5" oninput="updateSelectedSize(this.value)">
                </div>
                <div class="ctrl-row">
                    <span>æ—‹è½‰</span>
                    <input type="range" id="rotate-slider" min="-180" max="180" step="5" oninput="updateSelectedRotation(this.value)">
                </div>
                <div style="text-align:right; margin-top:5px;">
                    <button class="btn" style="background:#ffcdd2; color:#c62828; font-size:12px; padding:5px 10px;" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>

            <div class="section-header">èƒŒæ™¯æ¨£å¼</div>
            <div class="scroll-row" id="bg-list"></div>
            <label class="btn" style="width:100%; box-sizing:border-box; margin:5px 0; font-size:12px; background:#e3f2fd; color:#1565c0;">
                ğŸ“‚ ä¸Šå‚³è‡ªè¨‚èƒŒæ™¯
                <input type="file" accept="image/*" onchange="uploadBg(this)" style="display:none;">
            </label>

            <div class="section-header">æ·»åŠ è²¼åœ– & æ–‡å­—</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" onclick="addTextObject()" style="flex:1; background:#fff3e0; color:#ef6c00;">âœï¸ æ–°å¢æ–‡å­—</button>
                <label class="btn" style="flex:1; margin:0; background:#f3e5f5; color:#8e24aa;">
                    ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡
                    <input type="file" accept="image/*" onchange="uploadSticker(this)" style="display:none;">
                </label>
            </div>
            <div class="sticker-grid" id="sticker-list"></div>

            <div style="margin-top:30px;">
                <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ä¸€éµåˆ—å° (Print)</button>
                <button class="btn-xl" style="margin-top:10px;" onclick="downloadImage()">â¬‡ ä¸‹è¼‰åœ–ç‰‡</button>
                <button class="btn" style="width:100%; margin:10px 0; background:#eee;" onclick="location.reload()">ğŸ”„ å…¨éƒ¨é‡ä¾†</button>
            </div>
        </div>

        <div class="editor-right">
            <canvas id="finalCanvas"></canvas>
        </div>
    </div>

<script>
    // --- è³‡æ–™è¨­å®š ---
    const COLORS = ['#fff', '#000', '#ffebf0', '#e3f2fd', '#f3e5f5', '#e8f5e9', '#fff3e0', '#fce4ec'];
    const GRADIENTS = [
        ['#ff9a9e', '#fecfef'], ['#a18cd1', '#fbc2eb'], ['#fad0c4', '#ffd1ff'], ['#84fab0', '#8fd3f4']
    ];
    const STICKERS = ['â¤ï¸','âœ¨','ğŸ€','ğŸ±','ğŸ¶','ğŸ”¥','ğŸ‘‘','ğŸŒˆ','ğŸŒ¸','ğŸ‚','ğŸ•¶ï¸','ğŸ“·'];

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let stream = null;
    let photos = [];
    let config = { format: '2x6', timer: 5, bg: '#ffebf0', bgType: 'color', bgImg: null };
    
    // ç‰©ä»¶ç³»çµ± (è²¼åœ– + æ–‡å­—)
    // type: 'image' | 'text' | 'emoji'
    let elements = [];
    let selectedIdx = -1;
    let isDragging = false;
    let dragStart = {x:0, y:0};

    // DOM
    const canvas = document.getElementById('finalCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('video');

    // --- åˆå§‹åŒ– ---
    function init() {
        // ç”ŸæˆèƒŒæ™¯æŒ‰éˆ•
        const bgList = document.getElementById('bg-list');
        COLORS.concat(GRADIENTS).forEach(c => {
            const div = document.createElement('div');
            div.className = 'color-dot';
            if(Array.isArray(c)) div.style.background = `linear-gradient(135deg, ${c[0]}, ${c[1]})`;
            else div.style.background = c;
            div.onclick = () => setBg(c);
            bgList.appendChild(div);
        });

        // ç”Ÿæˆè²¼åœ–æŒ‰éˆ•
        const stickerList = document.getElementById('sticker-list');
        STICKERS.forEach(s => {
            const div = document.createElement('div');
            div.className = 'sticker-item';
            div.innerText = s;
            div.onclick = () => addElement({type:'emoji', content:s, size:100});
            stickerList.appendChild(div);
        });

        // Canvas äº‹ä»¶ç›£è½
        canvas.addEventListener('mousedown', onDown);
        canvas.addEventListener('touchstart', onDown, {passive:false});
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchend', onUp);
    }
    init();

    // --- 1. ç›¸æ©Ÿèˆ‡æ‹æ” ---
    function setFormat(f) { 
        config.format = f; 
        document.querySelectorAll('#setup-page .btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btn-'+f).classList.add('active');
    }
    function setTimer(t, btn) {
        config.timer = t;
        btn.parentNode.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false
            });
            video.srcObject = stream;
            document.getElementById('camera-modal').style.display = 'flex'; // é–‹å•Ÿå…¨è¢å¹•
            
            // ç­‰å¾…ä¸€ä¸‹è®“ç›¸æ©Ÿç©©å®š
            setTimeout(startShootingSequence, 1000);
        } catch(e) {
            alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™');
        }
    }

    async function startShootingSequence() {
        photos = [];
        const cnt = document.getElementById('countdown');
        
        for(let i=0; i<4; i++) {
            // å€’æ•¸
            cnt.style.display = 'block';
            for(let t=config.timer; t>0; t--) {
                cnt.innerText = t;
                await new Promise(r => setTimeout(r, 1000));
            }
            cnt.style.display = 'none';

            // æ‹ç…§ (Flash effect)
            const flash = document.createElement('div');
            flash.style.cssText = 'position:fixed;inset:0;background:white;z-index:10000;';
            document.body.appendChild(flash);
            setTimeout(()=>flash.remove(), 100);
            
            snapPhoto();
            await new Promise(r => setTimeout(r, 1000)); // é è¦½åœç•™ä¸€ç§’
        }

        stopCamera();
        enterEditor();
    }

    function snapPhoto() {
        const temp = document.createElement('canvas');
        temp.width = 800; temp.height = 600; // 4:3
        const tctx = temp.getContext('2d');
        
        // é¡åƒç¿»è½‰ç¹ªè£½
        tctx.translate(800, 0); tctx.scale(-1, 1);
        
        // è£åˆ‡ (ä¿æŒæ¯”ä¾‹)
        const vw = video.videoWidth, vh = video.videoHeight;
        const rRatio = 800/600, vRatio = vw/vh;
        let sx, sy, sw, sh;
        
        if(vRatio > rRatio) {
            sh = vh; sw = vh * rRatio; sy = 0; sx = (vw - sw)/2;
        } else {
            sw = vw; sh = vw / rRatio; sx = 0; sy = (vh - sh)/2;
        }
        tctx.drawImage(video, sx, sy, sw, sh, 0, 0, 800, 600);
        photos.push(temp);
    }

    function stopCamera() {
        if(stream) stream.getTracks().forEach(t=>t.stop());
        document.getElementById('camera-modal').style.display = 'none';
    }

    // --- 2. ç·¨è¼¯å™¨é‚è¼¯ ---
    function enterEditor() {
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('editor-page').style.display = 'flex';
        
        // åˆå§‹åŒ–é è¨­æ–‡å­— (æ¨™é¡Œ & æ—¥æœŸ)
        const now = new Date();
        const dateStr = now.toLocaleDateString();
        
        // è¨ˆç®—ä¸­å¿ƒé»
        const cw = (config.format==='2x6')? 900 : 1800; 
        const ch = 2400; // æš«å®šé«˜åº¦

        // åŠ å…¥é è¨­æ–‡å­—ç‰©ä»¶
        elements = [];
        elements.push({
            type: 'text', content: 'LIFE4CUTS', 
            x: cw/2, y: ch - 200, size: 80, rotation: 0, color: '#333333'
        });
        elements.push({
            type: 'text', content: dateStr, 
            x: cw/2, y: ch - 120, size: 40, rotation: 0, color: '#666666'
        });

        renderCanvas();
    }

    // --- 3. ç¹ªåœ–å¼•æ“ ---
    function renderCanvas() {
        // è¨­å®šç•«å¸ƒå°ºå¯¸
        const photoW = 800, photoH = 600;
        const pad = 50, head = 100, foot = 400;
        const colW = photoW + pad*2;
        const colH = head + (photoH*4) + (pad*5) + foot;

        const finalW = (config.format==='2x6') ? colW : colW*2;
        const finalH = colH;

        canvas.width = finalW; canvas.height = finalH;

        // 1. ç•«èƒŒæ™¯
        if(config.bgType === 'image' && config.bgImg) {
            // Cover mode
            const img = config.bgImg;
            const iR = img.width/img.height, cR = finalW/finalH;
            let sx,sy,sw,sh;
            if(iR > cR) { sh=img.height; sw=sh*cR; sy=0; sx=(img.width-sw)/2; }
            else { sw=img.width; sh=sw/cR; sx=0; sy=(img.height-sh)/2; }
            ctx.drawImage(img, sx,sy,sw,sh, 0,0, finalW,finalH);
        } else if(Array.isArray(config.bg)) {
            const grd = ctx.createLinearGradient(0,0,finalW,finalH);
            grd.addColorStop(0, config.bg[0]); grd.addColorStop(1, config.bg[1]);
            ctx.fillStyle = grd; ctx.fillRect(0,0,finalW,finalH);
        } else {
            ctx.fillStyle = config.bg; ctx.fillRect(0,0,finalW,finalH);
        }

        // 2. ç•«ç…§ç‰‡ (å‡½æ•¸)
        const drawColumn = (offsetX) => {
            photos.forEach((p, i) => {
                const x = offsetX + pad;
                const y = head + pad + i*(photoH + pad);
                ctx.fillStyle = 'white';
                ctx.fillRect(x-15, y-15, photoW+30, photoH+30);
                ctx.drawImage(p, x, y, photoW, photoH);
            });
        };

        drawColumn(0);
        if(config.format==='4x6') {
            drawColumn(colW);
            // ä¸­é–“è™›ç·š
            ctx.beginPath(); ctx.setLineDash([20,20]); 
            ctx.moveTo(colW, 0); ctx.lineTo(colW, finalH);
            ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.lineWidth=4; ctx.stroke();
        }

        // 3. ç•«ç‰©ä»¶ (è²¼åœ–/æ–‡å­—)
        ctx.setLineDash([]);
        elements.forEach((el, idx) => {
            ctx.save();
            ctx.translate(el.x, el.y);
            ctx.rotate(el.rotation * Math.PI/180);

            if(el.type === 'text') {
                ctx.font = `bold ${el.size}px Arial`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = el.color;
                ctx.fillText(el.content, 0, 0);
            } else if(el.type === 'emoji') {
                ctx.font = `${el.size}px Arial`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(el.content, 0, 0);
            } else if(el.type === 'image') {
                const ratio = el.img.height / el.img.width;
                ctx.drawImage(el.img, -el.size/2, -el.size*ratio/2, el.size, el.size*ratio);
            }

            // é¸å–æ¡†
            if(idx === selectedIdx) {
                ctx.strokeStyle = '#007bff'; ctx.lineWidth = 4;
                // ç°¡å–®ä¼°ç®—åŒ…åœç›’
                let w=el.size, h=el.size;
                if(el.type==='text') { w = ctx.measureText(el.content).width; h = el.size; }
                else if(el.type==='image') { h = el.size * (el.img.height/el.img.width); }
                
                ctx.strokeRect(-w/2 - 10, -h/2 - 10, w+20, h+20);
            }
            ctx.restore();
        });
    }

    // --- 4. äº’å‹•æ“ä½œ (æ‹–æ›³/ä¿®æ”¹) ---
    function getPos(e) {
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width / r.width;
        const sy = canvas.height / r.height;
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (cx - r.left)*sx, y: (cy - r.top)*sy };
    }

    function onDown(e) {
        e.preventDefault();
        const p = getPos(e);
        // åå‘æª¢æŸ¥é»æ“Š
        let hit = -1;
        for(let i=elements.length-1; i>=0; i--) {
            const el = elements[i];
            // ç°¡å–®åˆ¤å®š (å„ªåŒ–é«”é©—ï¼šæ–‡å­—ç”¨å¯¬åº¦åˆ¤å®šï¼Œå…¶ä»–ç”¨size)
            let dist = Math.hypot(p.x - el.x, p.y - el.y);
            let limit = el.size;
            if(el.type === 'text') limit = el.size * 2; // æ–‡å­—çµ¦å¤§ä¸€é»åˆ¤å®šå€
            
            if(dist < limit) { hit = i; break; }
        }

        selectedIdx = hit;
        updateControls(); // æ›´æ–°UIé¢æ¿
        renderCanvas();

        if(hit !== -1) {
            isDragging = true;
            dragStart = p;
        }
    }

    function onMove(e) {
        if(!isDragging || selectedIdx === -1) return;
        e.preventDefault();
        const p = getPos(e);
        const dx = p.x - dragStart.x;
        const dy = p.y - dragStart.y;
        
        elements[selectedIdx].x += dx;
        elements[selectedIdx].y += dy;
        dragStart = p;
        renderCanvas();
    }

    function onUp() { isDragging = false; }

    // --- 5. UI æ§åˆ¶åŠŸèƒ½ ---
    function updateControls() {
        const panel = document.getElementById('object-controls');
        const textRow = document.getElementById('text-edit-row');
        const colorRow = document.getElementById('color-edit-row');

        if(selectedIdx === -1) {
            panel.style.display = 'none';
            return;
        }

        panel.style.display = 'block';
        const el = elements[selectedIdx];
        
        // æ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒæ§åˆ¶é …
        if(el.type === 'text') {
            textRow.style.display = 'flex';
            colorRow.style.display = 'flex';
            document.getElementById('edit-text-input').value = el.content;
            document.getElementById('edit-color-input').value = el.color;
        } else {
            textRow.style.display = 'none';
            colorRow.style.display = 'none';
        }

        document.getElementById('size-slider').value = el.size;
        document.getElementById('rotate-slider').value = el.rotation;
    }

    // ä¿®æ”¹å±¬æ€§
    function updateSelectedText(val) { if(selectedIdx!==-1){ elements[selectedIdx].content = val; renderCanvas(); }}
    function updateSelectedColor(val) { if(selectedIdx!==-1){ elements[selectedIdx].color = val; renderCanvas(); }}
    function updateSelectedSize(val) { if(selectedIdx!==-1){ elements[selectedIdx].size = parseInt(val); renderCanvas(); }}
    function updateSelectedRotation(val) { if(selectedIdx!==-1){ elements[selectedIdx].rotation = parseInt(val); renderCanvas(); }}
    function deleteSelected() { if(selectedIdx!==-1){ elements.splice(selectedIdx,1); selectedIdx=-1; updateControls(); renderCanvas(); }}

    // æ–°å¢ç‰©ä»¶
    function addTextObject() {
        addElement({type:'text', content:'è«‹è¼¸å…¥æ–‡å­—', size:60, color:'#000000'});
    }
    function addElement(props) {
        elements.push({
            x: canvas.width/2, y: canvas.height/2, rotation: 0,
            ...props
        });
        selectedIdx = elements.length - 1;
        updateControls();
        renderCanvas();
    }

    // èƒŒæ™¯èˆ‡ä¸Šå‚³
    function setBg(bg) { config.bg = bg; config.bgType = Array.isArray(bg)?'gradient':'color'; config.bgImg=null; renderCanvas(); }
    function uploadBg(input) {
        if(input.files[0]) {
            const img = new Image();
            img.onload = () => { config.bgImg=img; config.bgType='image'; renderCanvas(); };
            img.src = URL.createObjectURL(input.files[0]);
        }
    }
    function uploadSticker(input) {
        if(input.files[0]) {
            const img = new Image();
            img.onload = () => { addElement({type:'image', img:img, size:200}); };
            img.src = URL.createObjectURL(input.files[0]);
        }
    }

    // ä¸‹è¼‰
    function downloadImage() {
        selectedIdx = -1; renderCanvas(); // å»é™¤é¸å–æ¡†
        const link = document.createElement('a');
        link.download = `life4cuts-v4-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
</script>
</body>
</html>
