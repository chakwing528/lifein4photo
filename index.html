<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å°ˆå±¬äººç”Ÿå››æ ¼ | My Life4Cuts</title>
    <style>
        /* --- ç¶²ç«™åŸºæœ¬æ¨£å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #f4f4f9;
            color: #333;
            padding: 20px;
            margin: 0;
        }
        h1 { color: #4a4a4a; margin-bottom: 10px; }
        p.subtitle { color: #666; margin-bottom: 25px; }

        /* --- æ§åˆ¶å€èˆ‡æŒ‰éˆ•æ¨£å¼ --- */
        .controls-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: inline-block;
            margin-bottom: 20px;
        }
        .format-group { margin-bottom: 15px; }
        .btn {
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #e0e0e0;
            color: #333;
            border: 2px solid transparent;
            border-radius: 25px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background-color: #d0d0d0; transform: translateY(-2px); }
        /* é¸ä¸­ç‹€æ…‹çš„æŒ‰éˆ• */
        .btn.active {
            background-color: #ff7eb3;
            color: white;
            box-shadow: 0 4px 10px rgba(255, 126, 179, 0.4);
        }
        .btn-primary {
            background-color: #ff7eb3;
            color: white;
            font-weight: bold;
            font-size: 18px;
            padding: 12px 30px;
        }
        .btn-primary:hover { background-color: #ff65a3; box-shadow: 0 4px 12px rgba(255, 101, 163, 0.5); }

        /* --- ç›¸æ©Ÿé è¦½å€ --- */
        #camera-container {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            background: #000;
        }
        /* é¡åƒç¿»è½‰è¦–è¨Šï¼Œè®“è‡ªæ‹è¼ƒè‡ªç„¶ */
        video { 
            width: 100%; /* RWD è¨­å®š */
            max-width: 600px; 
            height: auto; 
            display: block;
            transform: scaleX(-1); 
        }
        
        /* --- å€’æ•¸è¨ˆæ™‚å™¨ --- */
        #countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            color: white;
            font-weight: 800;
            text-shadow: 4px 4px 10px rgba(0,0,0,0.7);
            display: none; /* é è¨­éš±è— */
            pointer-events: none;
        }

        /* --- çµæœé¡¯ç¤ºå€ --- */
        #result-container {
            display: none; /* é è¨­éš±è—ï¼Œæ‹å®Œé¡¯ç¤º */
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ccc;
        }
        /* æœ€çµ‚åˆæˆçš„ Canvas */
        canvas {
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            max-width: 90%; /* åœ¨æ‰‹æ©Ÿä¸Šä¸æœƒè¶…å‡ºè¢å¹• */
            height: auto;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .action-buttons {
            margin-top: 15px;
        }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (é‡è¦!) --- */
        /* ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ã€Œåˆ—å°ã€æ™‚ï¼Œéš±è—ç¶²é æ‰€æœ‰å…ƒç´ ï¼Œåªé¡¯ç¤ºé‚£å¼µç…§ç‰‡ */
        @media print {
            body * { visibility: hidden; }
            #result-container, #result-container * { visibility: visible; }
            #result-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                text-align: center;
            }
            /* å¼·åˆ¶ Canvas åœ¨åˆ—å°æ™‚ç¶­æŒé«˜å“è³ªä¸¦é©æ‡‰é é¢ */
            canvas {
                max-width: 100%;
                max-height: 100vh;
                box-shadow: none;
                width: auto; /* è®“ç€è¦½å™¨æ±ºå®šæœ€ä½³åˆ—å°å¯¬åº¦ */
            }
            .action-buttons, h3 { display: none; } /* åˆ—å°æ™‚ä¸é¡¯ç¤ºæŒ‰éˆ•å’Œæ¨™é¡Œ */
        }
    </style>
</head>
<body>

    <h1>ğŸ“¸ æˆ‘çš„å°ˆå±¬äººç”Ÿå››æ ¼</h1>
    <p class="subtitle">é¸æ“‡å°ºå¯¸ï¼Œæº–å‚™å¥½ä½ çš„ç¬‘å®¹ï¼(éœ€å…è¨±ç›¸æ©Ÿæ¬Šé™)</p>

    <div class="controls-section">
        <div class="format-group">
            <p style="margin: 5px 0; font-weight: bold;">é¸æ“‡åˆ—å°å°ºå¯¸ï¼š</p>
            <button id="btn-2x6" class="btn active" onclick="setFormat('2x6')">2x6 è‹±å‹ (ç¶“å…¸é•·æ¢)</button>
            <button id="btn-4x6" class="btn" onclick="setFormat('4x6')">4x6 è‹±å‹ (å…©æ¢ä¸¦æ’)</button>
        </div>
        <div>
            <button class="btn btn-primary" onclick="startCapture()">âœ¨ é–‹å§‹æ‹æ” (é€£æ‹4å¼µ) âœ¨</button>
        </div>
    </div>

    <br>
    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="countdown"></div>
    </div>

    <div id="result-container">
        <h3>ğŸ‰ æ‹æ”å®Œæˆï¼é è¦½ä½ çš„ç…§ç‰‡ï¼š</h3>
        <canvas id="finalCanvas"></canvas>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="downloadImage()">ğŸ“¥ ä¸‹è¼‰åœ–ç‰‡</button>
            <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°ç…§ç‰‡</button>
            <button class="btn" onclick="resetBooth()">ğŸ”„ é‡æ–°æ‹æ”</button>
        </div>
    </div>

    <script>
        // --- è®Šæ•¸å®£å‘Š ---
        const video = document.getElementById('video');
        const finalCanvas = document.getElementById('finalCanvas');
        const ctx = finalCanvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const resultContainer = document.getElementById('result-container');
        const btn2x6 = document.getElementById('btn-2x6');
        const btn4x6 = document.getElementById('btn-4x6');

        let photos = []; // å„²å­˜æ‹æ”çš„ 4 å¼µç…§ç‰‡ (canvas å…ƒç´ )
        let currentFormat = '2x6'; // é è¨­å°ºå¯¸

        // --- 1. åˆå§‹åŒ–ï¼šå•Ÿå‹•ç›¸æ©Ÿ ---
        // è«‹æ±‚ HD è§£æåº¦ (1280x720)ï¼Œå¦‚æœè£ç½®ä¸æ”¯æ´æœƒè‡ªå‹•é™ç´š
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 }, 
                height: { ideal: 720 },
                facingMode: "user" // å„ªå…ˆä½¿ç”¨å‰é¡é ­
            } 
        })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("ç›¸æ©ŸéŒ¯èª¤:", err);
            alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿã€‚è«‹ç¢ºä¿æ‚¨å·²å…è¨±ç¶²ç«™å­˜å–ç›¸æ©Ÿæ¬Šé™ã€‚\n(åœ¨ iOS ä¸Šè«‹ä½¿ç”¨ Safari ç€è¦½å™¨)");
        });

        // --- åŠŸèƒ½ï¼šåˆ‡æ›å°ºå¯¸ ---
        function setFormat(format) {
            currentFormat = format;
            // æ›´æ–°æŒ‰éˆ•å¤–è§€
            if (format === '2x6') {
                btn2x6.classList.add('active');
                btn4x6.classList.remove('active');
            } else {
                btn4x6.classList.add('active');
                btn2x6.classList.remove('active');
            }
            console.log("ç›®å‰å°ºå¯¸è¨­å®šç‚º:", currentFormat);
        }

        // --- åŠŸèƒ½ï¼šé–‹å§‹æ‹æ”æµç¨‹ ---
        async function startCapture() {
            photos = []; // æ¸…ç©ºèˆŠç…§ç‰‡
            resultContainer.style.display = 'none'; // éš±è—ä¸Šæ¬¡çµæœ
            // æ»¾å‹•åˆ°ç›¸æ©Ÿä½ç½®
            document.getElementById('camera-container').scrollIntoView({ behavior: 'smooth' });

            // åŸ·è¡Œ 4 æ¬¡æ‹æ”å¾ªç’°
            for (let i = 1; i <= 4; i++) {
                await runCountdown(3); // å€’æ•¸ 3 ç§’
                capturePhoto(); // æ‹ç…§
                // é–ƒå…‰ç‡ˆæ•ˆæœ (é¸ç”¨)
                document.body.style.backgroundColor = 'white';
                setTimeout(() => document.body.style.backgroundColor = '#f4f4f9', 100);
            }

            mergePhotos(); // 4å¼µæ‹å®Œå¾Œï¼Œé€²è¡Œåˆä½µ
        }

        // --- è¼”åŠ©åŠŸèƒ½ï¼šå€’æ•¸è¨ˆæ™‚ ---
        function runCountdown(seconds) {
            return new Promise(resolve => {
                countdownEl.style.display = 'block';
                let counter = seconds;
                countdownEl.innerText = counter;
                
                const timer = setInterval(() => {
                    counter--;
                    if (counter > 0) {
                        countdownEl.innerText = counter;
                    } else {
                        clearInterval(timer);
                        countdownEl.style.display = 'none';
                        resolve(); // å€’æ•¸çµæŸï¼ŒPromise å®Œæˆ
                    }
                }, 1000);
            });
        }

        // --- åŠŸèƒ½ï¼šæ“·å–å–®å¼µç…§ç‰‡ ---
        function capturePhoto() {
            // å»ºç«‹ä¸€å€‹æš«æ™‚çš„ canvas ä¾†æŠ“å–è¦–è¨Šç•¶ä¸‹çš„å½±æ ¼
            const tempCanvas = document.createElement('canvas');
            // ç¢ºä¿æŠ“å–åˆ°çš„è§£æåº¦èˆ‡è¦–è¨Šæºä¸€è‡´
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            // **é—œéµï¼šè™•ç†é¡åƒç¿»è½‰**
            // å› ç‚ºé è¦½ç•«é¢ç‚ºäº†è‡ªç„¶é€šå¸¸æ˜¯é¡åƒçš„ï¼Œæˆ‘å€‘å¸Œæœ›å­˜ä¸‹ä¾†çš„ç…§ç‰‡ä¹Ÿæ˜¯é¡åƒçš„
            tempCtx.translate(tempCanvas.width, 0);
            tempCtx.scale(-1, 1);
            
            // å°‡è¦–è¨Šç•«é¢ç•«åˆ°æš«å­˜ canvas ä¸Š
            tempCtx.drawImage(video, 0, 0);
            photos.push(tempCanvas); // å­˜å…¥é™£åˆ—
            console.log("å·²æ‹æ”ç…§ç‰‡:", photos.length);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šåˆä½µç…§ç‰‡ (ç¹ªè£½äººç”Ÿå››æ ¼) ---
        function mergePhotos() {
            // è¨­å®šåƒæ•¸ (ä»¥ 300 DPI ç‚ºæ¨™æº–ï¼Œç¢ºä¿åˆ—å°æ¸…æ™°)
            const photoWidth = 560;  // å–®å¼µç…§ç‰‡å¯¬åº¦
            const photoHeight = 420; // å–®å¼µç…§ç‰‡é«˜åº¦ (4:3 æ¯”ä¾‹)
            const paddingX = 20; // æ°´å¹³é‚Šè·
            const paddingY = 20; // å‚ç›´é–“è·
            const headerHeight = 60; // é ‚éƒ¨ç•™ç™½
            const footerHeight = 100; // åº•éƒ¨ç•™ç™½ (æ”¾æ–‡å­—ç”¨)
            
            // è¨ˆç®—å–®ä¸€æ¢(2x6)çš„ç¸½é«˜åº¦
            const singleStripHeight = headerHeight + (photoHeight * 4) + (paddingY * 5) + footerHeight;
            // è¨ˆç®—å–®ä¸€æ¢(2x6)çš„ç¸½å¯¬åº¦
            const singleStripWidth = photoWidth + (paddingX * 2);

            let finalWidth, finalHeight;

            if (currentFormat === '2x6') {
                // --- 2x6 æ¨¡å¼ï¼šå–®æ¢å‚ç›´ ---
                finalWidth = singleStripWidth;
                finalHeight = singleStripHeight;
            } else {
                // --- 4x6 æ¨¡å¼ï¼šå…©æ¢ä¸¦æ’ ---
                finalWidth = singleStripWidth * 2; // å¯¬åº¦åŠ å€
                finalHeight = singleStripHeight;   // é«˜åº¦ä¸è®Š
            }

            // è¨­å®šæœ€çµ‚ Canvas å°ºå¯¸
            finalCanvas.width = finalWidth;
            finalCanvas.height = finalHeight;

            // 1. å¡«æ»¿èƒŒæ™¯è‰² (å¯ä»¥è‡ªå·±æ”¹é¡è‰²ç¢¼ï¼Œä¾‹å¦‚æ·ºç²‰ç´… #ffe4e1)
            ctx.fillStyle = "#ffffff"; 
            ctx.fillRect(0, 0, finalWidth, finalHeight);

            // 2. å®šç¾©ç¹ªè£½å–®æ¢ç…§ç‰‡çš„å‡½æ•¸
            function drawStrip(startX) {
                photos.forEach((photoCanvas, index) => {
                    // è¨ˆç®—æ¯å¼µç…§ç‰‡çš„ Y åº§æ¨™
                    const y = headerHeight + paddingY + (index * (photoHeight + paddingY));
                    const x = startX + paddingX;

                    // ç¹ªè£½ç…§ç‰‡é‚Šæ¡†é™°å½± (é¸ç”¨ï¼Œå¢åŠ ç«‹é«”æ„Ÿ)
                    ctx.fillStyle = "rgba(0,0,0,0.05)";
                    ctx.fillRect(x + 5, y + 5, photoWidth, photoHeight);

                    // ç¹ªè£½ç…§ç‰‡ (æœƒè‡ªå‹•ç¸®æ”¾ä»¥é©æ‡‰æ¡†æ¡†)
                    // drawImage(ä¾†æº, x, y, å¯¬, é«˜)
                    ctx.drawImage(photoCanvas, x, y, photoWidth, photoHeight);
                });

                // ç¹ªè£½åº•éƒ¨æ–‡å­—
                ctx.fillStyle = "#555";
                ctx.font = "bold 24px Arial";
                ctx.textAlign = "center";
                ctx.fillText("MY LIFE4CUTS", startX + (singleStripWidth / 2), finalHeight - 55);
                ctx.font = "18px Arial";
                ctx.fillText(new Date().toLocaleDateString(), startX + (singleStripWidth / 2), finalHeight - 25);
            }

            // 3. é–‹å§‹ç¹ªè£½
            if (currentFormat === '2x6') {
                drawStrip(0); // ç•«ä¸€æ¢ï¼Œèµ·å§‹ X ç‚º 0
            } else {
                // 4x6 æ¨¡å¼ï¼šç•«å…©æ¬¡
                drawStrip(0); // å·¦é‚Šé‚£æ¢
                drawStrip(singleStripWidth); // å³é‚Šé‚£æ¢ (èµ·å§‹ X å¾€å³ç§»)

                // ç•«ä¸­é–“çš„è£åˆ‡è™›ç·š
                ctx.beginPath();
                ctx.setLineDash([15, 15]); // è™›ç·šæ¨£å¼
                ctx.moveTo(singleStripWidth, 0);
                ctx.lineTo(singleStripWidth, finalHeight);
                ctx.strokeStyle = '#d0d0d0';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // é¡¯ç¤ºçµæœå€åŸŸ
            resultContainer.style.display = 'block';
            // å¹³æ»‘æ»¾å‹•åˆ°çµæœå€
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // --- åŠŸèƒ½ï¼šä¸‹è¼‰åœ–ç‰‡ ---
        function downloadImage() {
            const link = document.createElement('a');
            // è¨­å®šä¸‹è¼‰çš„æª”åï¼ŒåŒ…å«æ™‚é–“æˆ³è¨˜
            link.download = `life4cuts-${currentFormat}-${Date.now()}.png`;
            // å°‡ Canvas è½‰ç‚ºåœ–ç‰‡ URL
            link.href = finalCanvas.toDataURL('image/png', 1.0); // ä½¿ç”¨æœ€é«˜å“è³ª
            link.click();
        }

        // --- åŠŸèƒ½ï¼šé‡æ–°æ‹æ” ---
        function resetBooth() {
            resultContainer.style.display = 'none';
            document.getElementById('camera-container').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
